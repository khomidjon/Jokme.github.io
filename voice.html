<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis Voice AI</title>
    <style>
        body { margin: 0; background: #050505; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: #fff; }
        
        /* UI Elementlari */
        .glass-back-btn {
            position: fixed; top: 25px; left: 25px; padding: 12px 25px;
            text-decoration: none; color: #00d2ff; z-index: 10001; font-weight: bold;
            background: rgba(0, 210, 255, 0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 210, 255, 0.3); border-radius: 20px;
            transition: 0.3s;
        }
        .glass-back-btn:hover { background: rgba(0, 210, 255, 0.3); box-shadow: 0 0 15px #00d2ff; }

        /* Status va Mikrofon */
        #status-container {
            position: fixed; bottom: 40px; width: 100%; text-align: center; pointer-events: none;
        }
        #status-text {
            font-size: 18px; color: #00d2ff; text-transform: uppercase; letter-spacing: 3px;
            text-shadow: 0 0 10px #00d2ff; font-weight: bold;
        }

        .mic-wrapper {
            position: fixed; top: 30px; right: 30px; z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }
        .mic-icon {
            width: 60px; height: 60px; border-radius: 50%;
            background: rgba(0, 210, 255, 0.1); border: 2px solid #00d2ff;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: #00d2ff; cursor: pointer;
            box-shadow: 0 0 15px #00d2ff; transition: 0.3s;
        }
        
        /* Tinglash animatsiyasi */
        .listening { animation: pulse 1.5s infinite; background: rgba(0, 210, 255, 0.4); }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 10px #00d2ff; }
            50% { transform: scale(1.15); box-shadow: 0 0 30px #00d2ff; }
            100% { transform: scale(1); box-shadow: 0 0 10px #00d2ff; }
        }

        /* Yashirin Canvas (Matnni o'qish uchun) */
        #textCanvas { display: none; }
    </style>
</head>
<body>

    <a href="dashboard.html" class="glass-back-btn">â€¹ DASHBOARD</a>

    <div class="mic-wrapper">
        <div class="mic-icon" id="mic-btn">ðŸŽ¤</div>
    </div>

    <div id="status-container">
        <div id="status-text">JARVIS TIZIMI FAOL</div>
    </div>

    <canvas id="textCanvas"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // ==========================================
        // 1. O'ZGARUVCHILAR VA SOZLAMALAR
        // ==========================================
        let scene, camera, renderer, particles, geometry;
        const particleCount = 15000; // Zarrachalar soni
        
        // Zarrachalar pozitsiyalari
        const currentPos = new Float32Array(particleCount * 3);
        const targetPos = new Float32Array(particleCount * 3);
        const homePos = new Float32Array(particleCount * 3); // Shar shakli (uy)

        let isTextMode = false;
        const colorBlue = new THREE.Color(0x00d2ff);
        const colorRed = new THREE.Color(0xff0000); // So'kinganda qizil bo'ladi

        // Ovoz sozlamalari
        let recognition;
        let silenceTimer;
        let resetTimer;
        const synth = window.speechSynthesis;

        // ==========================================
        // 2. THREE.JS (3D DUNYO)
        // ==========================================
        function initThree() {
            scene = new THREE.Scene();
            // Tuman effekti (orqa fon bilan uyg'unlashish uchun)
            scene.fog = new THREE.FogExp2(0x050505, 0.02);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 30;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Boshlang'ich shakl: Shar (Sphere)
            for (let i = 0; i < particleCount; i++) {
                const phi = Math.acos(-1 + (2 * i) / particleCount);
                const theta = Math.sqrt(particleCount * Math.PI) * phi;

                const r = 10; // Shar radiusi
                const x = r * Math.cos(theta) * Math.sin(phi);
                const y = r * Math.sin(theta) * Math.sin(phi);
                const z = r * Math.cos(phi);

                // Home va Current pozitsiyalarni to'ldiramiz
                homePos[i * 3] = x; homePos[i * 3 + 1] = y; homePos[i * 3 + 2] = z;
                currentPos[i * 3] = x; currentPos[i * 3 + 1] = y; currentPos[i * 3 + 2] = z;
                targetPos[i * 3] = x; targetPos[i * 3 + 1] = y; targetPos[i * 3 + 2] = z;
            }

            geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.BufferAttribute(currentPos, 3));

            const material = new THREE.PointsMaterial({
                size: 0.15,
                color: colorBlue,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            animate();
        }

        // Animatsiya sikli
        function animate() {
            requestAnimationFrame(animate);

            const positions = particles.geometry.attributes.position.array;
            
            // Lerp (Silliq o'tish) algoritmi
            for (let i = 0; i < particleCount * 3; i++) {
                // Hozirgi joyidan maqsadga (target) qarab 5% tezlikda siljiydi
                positions[i] += (targetPos[i] - positions[i]) * 0.08;
            }

            // Shar holatida biroz aylanishi uchun
            if (!isTextMode) {
                particles.rotation.y += 0.002;
                particles.rotation.z += 0.001;
            } else {
                // Matn holatida tekis tursin
                particles.rotation.y += (0 - particles.rotation.y) * 0.05;
                particles.rotation.z += (0 - particles.rotation.z) * 0.05;
            }

            particles.geometry.attributes.position.needsUpdate = true;
            renderer.render(scene, camera);
        }

        // ==========================================
        // 3. MATNNI ZARRACHALARGA AYLANTIRISH
        // ==========================================
        function textToParticles(text) {
            isTextMode = true;
            
            // 1. Yashirin Canvasda matn chizamiz
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400; // Sifati
            canvas.height = 100;
            
            ctx.fillStyle = '#000000'; // Orqa fon
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#ffffff'; // Matn rangi
            ctx.font = 'bold 60px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);

            // 2. Piksel ma'lumotlarini o'qiymiz
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            const validPixels = [];

            // 3. Oq piksellarni koordinataga aylantiramiz
            for (let y = 0; y < canvas.height; y += 2) { // Har 2-pikselni olamiz (optimallashtirish)
                for (let x = 0; x < canvas.width; x += 2) {
                    const index = (y * canvas.width + x) * 4;
                    // Agar piksel yorqin bo'lsa (matn qismi)
                    if (imageData[index] > 128) {
                        validPixels.push({
                            x: (x - canvas.width / 2) * 0.15, // Masshtab
                            y: -(y - canvas.height / 2) * 0.15 // Y o'qi teskari bo'ladi canvasda
                        });
                    }
                }
            }

            // 4. Target pozitsiyalarni yangilash
            // Agar matn piksellari kam bo'lsa, zarrachalarni takrorlaymiz
            for (let i = 0; i < particleCount; i++) {
                const pixel = validPixels[i % validPixels.length];
                if (pixel) {
                    targetPos[i * 3] = pixel.x;
                    targetPos[i * 3 + 1] = pixel.y;
                    targetPos[i * 3 + 2] = (Math.random() - 0.5) * 0.5; // Ozgina qalinlik (Z)
                } else {
                    // Ortiqcha zarrachalarni orqaga yashiramiz
                    targetPos[i * 3] = (Math.random() - 0.5) * 50;
                    targetPos[i * 3 + 1] = (Math.random() - 0.5) * 50;
                    targetPos[i * 3 + 2] = -50; 
                }
            }
        }

        function returnToSphere() {
            isTextMode = false;
            particles.material.color.set(colorBlue); // Rangni tiklash
            // Targetni uyga qaytarish
            for (let i = 0; i < particleCount * 3; i++) {
                targetPos[i] = homePos[i];
            }
            document.getElementById('status-text').innerText = "JARVIS KUTMOQDA...";
        }

        // ==========================================
        // 4. OVOZNI ANIQLASH VA LOGIKA (JARVIS)
        // ==========================================
        function setupVoice() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Brauzeringiz ovozli buyruqlarni qo'llamaydi (Chrome ishlating).");
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = 'uz-UZ'; // O'zbek tili
            recognition.continuous = true; // Uzluksiz tinglash
            recognition.interimResults = true; // Oraliq natijalar

            const statusText = document.getElementById('status-text');
            const micBtn = document.getElementById('mic-btn');

            recognition.onstart = () => {
                statusText.innerText = "TINGLANMOQDA...";
                micBtn.classList.add('listening');
            };

            recognition.onend = () => {
                micBtn.classList.remove('listening');
                // Agar o'chib qolsa, qayta yoqamiz
                setTimeout(() => { if (!isTextMode) recognition.start(); }, 1000);
            };

            recognition.onresult = (event) => {
                clearTimeout(silenceTimer); // Avvalgi taymerni to'xtatamiz

                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                
                // Real vaqtda matnni konsolga chiqarish (debug)
                console.log("Eshitildi:", transcript);

                // 1 sekund sukunatdan keyin ishga tushirish
                silenceTimer = setTimeout(() => {
                    processCommand(transcript.trim());
                }, 1000);
            };

            // Tugma bosilganda
            micBtn.onclick = () => {
                try { recognition.start(); } catch(e) { recognition.stop(); }
            };
            
            // Avtomatik boshlash
            recognition.start();
        }

        // --- ASOSIY MANTIQ (BRAIN) ---
        function processCommand(text) {
            if (!text) return;

            let responseText = "";
            let displayText = "";
            let isAngry = false;

            const lowerText = text.toLowerCase();

            // 1. Assalomu aleykum logikasi
            if (lowerText.includes("assalomu") || lowerText.includes("salom")) {
                displayText = "VAALAYKUM ASSALOM";
                responseText = "Vaalaykum assalom, xush kelibsiz";
            }
            // 2. So'kish logikasi
            else if (lowerText.includes("fuck") || lowerText.includes("foku")) {
                displayText = "FUCK YOU TOO!";
                responseText = "Fuck you too";
                isAngry = true;
            }
            // 3. Oddiy gapni qaytarish
            else {
                // Ekranga sig'ishi uchun uzun gapni qisqartirish
                displayText = text.length > 15 ? text.substring(0, 15) + "..." : text;
                displayText = displayText.toUpperCase();
                responseText = text;
            }

            // Rangni o'zgartirish (So'kishda qizil)
            if (isAngry) {
                particles.material.color.set(colorRed);
            } else {
                particles.material.color.set(colorBlue);
            }

            // Vizualizatsiya
            textToParticles(displayText);
            document.getElementById('status-text').innerText = "JAVOB BERILMOQDA...";

            // Ovozli javob (TTS)
            speak(responseText);

            // 3 Sekunddan keyin sharga qaytish
            clearTimeout(resetTimer);
            resetTimer = setTimeout(() => {
                returnToSphere();
            }, 3000 + (responseText.length * 50)); // Matn uzunligiga qarab vaqt qo'shiladi
        }

        // Gapirish funksiyasi
        function speak(text) {
            if (synth.speaking) synth.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            // Ovoz parametrlarini sozlash
            utterance.pitch = 0.9; // Biroz pastroq ovoz (Jarvis)
            utterance.rate = 1; 
            // O'zbek ovozi bo'lmasa, inglizcha o'qiydi (lekin browserga bog'liq)
            // utterance.lang = 'uz-UZ'; 
            
            synth.speak(utterance);
        }

        // ==========================================
        // 5. ISHGA TUSHIRISH
        // ==========================================
        window.onload = () => {
            initThree();
            setupVoice();
        };

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
