<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS AI Final</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            overflow: hidden;
            color: #00d4ff;
        }

        /* Orqaga tugmasi */
        .back-btn {
            position: fixed; top: 20px; left: 20px; padding: 10px 20px;
            background: rgba(0, 212, 255, 0.1); border: 1px solid #00d4ff;
            color: #00d4ff; text-decoration: none; z-index: 10000;
            border-radius: 5px; backdrop-filter: blur(5px);
            transition: 0.3s; font-weight: bold; text-transform: uppercase;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
        }
        .back-btn:hover {
            background: rgba(0, 212, 255, 0.3); box-shadow: 0 0 20px #00d4ff; transform: scale(1.05);
        }

        /* Intro */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 9999; display: flex;
            justify-content: center; align-items: center;
            opacity: 1; transition: opacity 1s ease-out;
        }
        .intro-content { display: flex; align-items: center; gap: 30px; }
        #edge-logo {
            width: 120px; height: auto;
            animation: spinIn 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards, glowBlue 2s infinite alternate;
        }
        #intro-text {
            font-size: 50px; font-weight: bold; color: #00d2ff; text-shadow: 0 0 15px #00d2ff;
        }
        
        @keyframes spinIn {
            0% { transform: rotate(0deg) scale(0); opacity: 0; }
            50% { transform: rotate(360deg) scale(1.2); opacity: 1; }
            100% { transform: rotate(720deg) scale(1); opacity: 1; }
        }
        @keyframes glowBlue {
            0% { filter: drop-shadow(0 0 5px #00d2ff); }
            100% { filter: drop-shadow(0 0 15px #00d2ff) drop-shadow(0 0 25px #00d2ff); }
        }

        #video { display: none; }
        #hand-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 15; }
        #particle-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 5; }
        #hud-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 10; }
        
        /* Status Panel */
        #status-panel {
            position: absolute; top: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 20, 40, 0.8); border: 2px solid #00d4ff;
            padding: 15px 30px; text-align: center; box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 30px rgba(0, 212, 255, 0.5); }
            50% { box-shadow: 0 0 50px rgba(0, 212, 255, 0.8); }
        }
        
        #jarvis-text { font-size: 24px; font-weight: bold; letter-spacing: 3px; }
        #mode-text { font-size: 14px; margin-top: 5px; color: #4df3ff; }
        
        /* Rang Palitrasi */
        #color-palette {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; background: rgba(0, 20, 40, 0.9);
            padding: 15px; border: 2px solid #00d4ff; border-radius: 10px;
            pointer-events: all; z-index: 20;
        }
        .color-btn { width: 40px; height: 40px; border: 2px solid #fff; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        .color-btn:hover { transform: scale(1.2); box-shadow: 0 0 20px #fff; }
        .color-btn.active { border: 3px solid #00d4ff; box-shadow: 0 0 25px #00d4ff; transform: scale(1.15); }

        /* Bildirishnoma */
        #notification {
            position: absolute; top: 150px; right: 30px;
            background: rgba(0, 212, 255, 0.2); border-left: 4px solid #00d4ff;
            padding: 15px; max-width: 300px; opacity: 0; transform: translateX(400px);
            transition: all 0.5s;
        }
        #notification.show { opacity: 1; transform: translateX(0); }
        
        /* Grid Chiziqlar */
        .grid-line { position: absolute; background: rgba(0, 212, 255, 0.1); }
        .grid-h { width: 100%; height: 1px; }
        .grid-v { height: 100%; width: 1px; }
    </style>
</head>
<body>
    <script>
        if (!localStorage.getItem('atom_user')) { window.location.href = 'index.html'; }
    </script>

    <a href="dashboard.html" class="back-btn">‚Üê Orqaga</a>

    <div id="intro-screen">
        <div class="intro-content">
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/98/Microsoft_Edge_logo_%282019%29.svg" alt="Microsoft Edge Logo" id="edge-logo">
            <h1 id="intro-text">Homidjon Coding...</h1>
        </div>
    </div>

    <video id="video"></video>
    <canvas id="hand-canvas"></canvas>
    <canvas id="particle-canvas"></canvas>
    
    <div id="hud-overlay">
        <div id="status-panel">
            <div id="jarvis-text">JARVIS AI SYSTEM</div>
            <div id="mode-text">INITIALIZING...</div>
        </div>
        <div id="notification"></div>
    </div>
    
    <div id="color-palette"></div>

    <script>
        // Intro
        setTimeout(() => {
            document.getElementById('intro-screen').style.opacity = '0';
            setTimeout(() => document.getElementById('intro-screen').style.display = 'none', 1000);
        }, 3000);

        // O'zgaruvchilar
        const video = document.getElementById('video');
        const handCanvas = document.getElementById('hand-canvas');
        const handCtx = handCanvas.getContext('2d');
        const particleCanvas = document.getElementById('particle-canvas');
        const pCtx = particleCanvas.getContext('2d');
        const modeText = document.getElementById('mode-text');
        const notification = document.getElementById('notification');
        const colorPalette = document.getElementById('color-palette');
        
        // Canvas hajmi
        function resizeCanvas() {
            handCanvas.width = window.innerWidth;
            handCanvas.height = window.innerHeight;
            particleCanvas.width = window.innerWidth;
            particleCanvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Ranglar
        const colors = ['#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF', '#9400D3', '#00CED1', '#ffffff'];
        let currentColor = '#FF0000';
        let currentColorRGB = {r:255, g:0, b:0};
        let isEraser = false;

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : {r: 255, g: 0, b: 0};
        }

        // Palitra yaratish
        colors.forEach((color, index) => {
            const btn = document.createElement('div');
            btn.className = 'color-btn';
            btn.style.backgroundColor = color;
            if (index === 0) btn.classList.add('active');
            btn.onclick = () => selectColor(color, btn, false);
            colorPalette.appendChild(btn);
        });

        // O'chirg'ich tugmasi
        const eraserBtn = document.createElement('div');
        eraserBtn.className = 'color-btn';
        eraserBtn.innerHTML = 'üóëÔ∏è'; 
        eraserBtn.style.background = '#333';
        eraserBtn.style.display = 'flex'; eraserBtn.style.justifyContent = 'center'; eraserBtn.style.alignItems = 'center';
        eraserBtn.style.fontSize = '20px';
        eraserBtn.onclick = () => selectColor('#FF0000', eraserBtn, true);
        colorPalette.appendChild(eraserBtn);

        function selectColor(color, btn, eraser) {
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            isEraser = eraser;
            if (!eraser) {
                currentColor = color;
                currentColorRGB = hexToRgb(color);
            }
        }

        // Grid chizish
        for(let i=0; i<10; i++){
            let h = document.createElement('div'); h.className='grid-line grid-h'; h.style.top=(i*10)+'%'; document.body.appendChild(h);
            let v = document.createElement('div'); v.className='grid-line grid-v'; v.style.left=(i*10)+'%'; document.body.appendChild(v);
        }

        // Three.js Setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.insertBefore(renderer.domElement, document.body.firstChild);
        
        scene.add(new THREE.AmbientLight(0x404040, 2));
        const pointLight = new THREE.PointLight(0x00d4ff, 2, 100);
        pointLight.position.set(0, 10, 10);
        scene.add(pointLight);
        camera.position.z = 25;

        // Logic Variables
        let drawingPoints = [];
        let drawingColors = [];
        let tempLines = [];
        let objects3D = [];
        let grabbedObject = null;
        let lastNotificationTime = 0;

        function showNotification(text) {
            let now = Date.now();
            if (now - lastNotificationTime < 2000) return;
            lastNotificationTime = now;
            notification.textContent = text;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 2000);
        }

        // MAIN LOGIC
        function onResults(results) {
            handCtx.clearRect(0, 0, handCanvas.width, handCanvas.height);
            handCtx.save();
            // Mirror Effect
            handCtx.translate(handCanvas.width, 0);
            handCtx.scale(-1, 1);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const hand = results.multiHandLandmarks[0];
                const indexTip = hand[8];
                const thumbTip = hand[4];
                const middleTip = hand[12];
                const ringTip = hand[16];
                const pinkyTip = hand[20];
                
                // Koordinatalar
                const screenX = (1 - indexTip.x) * window.innerWidth;
                const screenY = indexTip.y * window.innerHeight;
                
                // 3D Mapping (Kengaytirilgan)
                const x = (screenX / window.innerWidth - 0.5) * 45;
                const y = -(screenY / window.innerHeight - 0.5) * 35;
                const pos = new THREE.Vector3(x, y, 0);

                // --- GESTURE DETECTION (Aniqroq mantiq) ---

                // 1. Musht (Fist) - Barcha barmoq uchlari pastda
                // Barmoq uchi (8,12,16,20) bo'g'imdan (5,9,13,17) pastda yoki juda yaqin
                const isFist = (hand[8].y > hand[6].y && hand[12].y > hand[10].y && hand[16].y > hand[14].y && hand[20].y > hand[18].y);

                // 2. Pinch (Chimshilash) - Agar musht bo'lmasa, Index va Thumb yaqin
                const isPinching = !isFist && (Math.hypot(indexTip.x - thumbTip.x, indexTip.y - thumbTip.y) < 0.1);

                // 3. Pointing (Ko'rsatish) - Agar musht va pinch bo'lmasa, faqat ko'rsatkich barmoq tik
                const isPointing = !isFist && !isPinching && (hand[8].y < hand[6].y && hand[12].y > hand[10].y);

                // 4. Open Hand (Ochiq qo'l)
                const isOpenHand = !isFist && !isPinching && (hand[8].y < hand[6].y && hand[12].y < hand[10].y && hand[16].y < hand[14].y);

                // --- VISUAL VARIABLES ---
                let skeletonColor = '#00d4ff';
                let glowColor = '#ffffff';
                let glowSize = 15;
                let activeLandmark = 8; // Default: Index tip

                if (isFist) {
                    // --- REJIM: AYLANTIRISH (ROTATE) ---
                    modeText.textContent = 'REJIM: AYLANTIRISH (MUSHT)';
                    skeletonColor = '#FF00FF'; // Magenta
                    glowColor = '#FF00FF';
                    glowSize = 25;
                    activeLandmark = 9; // Musht bo'lganda o'rta bo'g'im yonadi

                    // Obyektni topish (agar ushlanmagan bo'lsa)
                    if (!grabbedObject) {
                        // Musht bo'lganda radius kattaroq (8 birlik)
                        for (let obj of objects3D) {
                            if (pos.distanceTo(obj.position) < 8) {
                                grabbedObject = obj;
                                showNotification('Obyekt tanlandi: Aylantirish');
                                break;
                            }
                        }
                    }

                    // Agar obyekt ushlangan bo'lsa, aylantiramiz
                    if (grabbedObject) {
                        // Qo'lning holatiga qarab aylantirish
                        // Markazdan og'ishni hisoblaymiz
                        const rotX = (indexTip.x - 0.5) * 5; // O'ng-chap
                        const rotY = (indexTip.y - 0.5) * 5; // Tepa-past
                        
                        grabbedObject.rotation.y = rotX * Math.PI; 
                        grabbedObject.rotation.x = rotY * Math.PI;
                    }

                } else if (isPinching) {
                    // --- REJIM: KO'CHIRISH (MOVE) ---
                    if (isEraser) {
                        modeText.textContent = 'REJIM: OCHIRISH';
                        skeletonColor = '#FF0000'; glowColor = '#FF0000';
                        // O'chirish logikasi
                        for (let i = objects3D.length - 1; i >= 0; i--) {
                            if (pos.distanceTo(objects3D[i].position) < 5) {
                                scene.remove(objects3D[i]);
                                objects3D.splice(i, 1);
                                showNotification('Obyekt o\'chirildi');
                                grabbedObject = null;
                                break;
                            }
                        }
                    } else {
                        modeText.textContent = 'REJIM: KO\'CHIRISH (PINCH)';
                        skeletonColor = '#00FFFF'; // Cyan
                        glowColor = '#00FFFF';
                        glowSize = 20;

                        if (!grabbedObject) {
                            for (let obj of objects3D) {
                                if (pos.distanceTo(obj.position) < 6) {
                                    grabbedObject = obj;
                                    showNotification('Obyekt ushlandi');
                                    break;
                                }
                            }
                        } else {
                            // Faqat joyini o'zgartiramiz (aylantirmaymiz)
                            grabbedObject.position.lerp(pos, 0.2);
                        }
                    }

                } else if (isPointing) {
                    // --- REJIM: CHIZISH ---
                    modeText.textContent = 'REJIM: CHIZISH';
                    skeletonColor = '#FFA500'; // Orange
                    glowColor = '#FFA500';
                    grabbedObject = null; // Qo'yib yuborish

                    drawingPoints.push(pos.clone());
                    drawingColors.push(currentColor);

                    // Chiziq chizish
                    if (drawingPoints.length > 1) {
                        const last = drawingPoints[drawingPoints.length - 2];
                        if (last.distanceTo(pos) > 0.1) {
                            const geometry = new THREE.CylinderGeometry(0.12, 0.12, last.distanceTo(pos), 8);
                            const material = new THREE.MeshPhongMaterial({ color: currentColor, emissive: currentColor });
                            const cyl = new THREE.Mesh(geometry, material);
                            cyl.position.copy(last).lerp(pos, 0.5);
                            cyl.lookAt(pos);
                            cyl.rotateX(Math.PI / 2);
                            scene.add(cyl);
                            tempLines.push(cyl);
                        }
                    }

                } else if (isOpenHand && drawingPoints.length > 5) {
                    // --- REJIM: YARATISH ---
                    modeText.textContent = 'REJIM: 3D GENERATSIYA...';
                    createHolographicObject();
                    showNotification('Yangi obyekt yaratildi');
                    skeletonColor = '#00FF00'; glowColor = '#00FF00';
                    grabbedObject = null;

                } else {
                    modeText.textContent = 'REJIM: KUTISH';
                    skeletonColor = '#00d4ff'; glowColor = '#ffffff';
                    grabbedObject = null;
                }

                // --- VISUALS: SKELET VA NUR ---
                
                // 1. Skelet chizish
                drawConnectors(handCtx, hand, HAND_CONNECTIONS, {color: skeletonColor, lineWidth: 2});
                drawLandmarks(handCtx, hand, {color: skeletonColor, radius: 2});

                // 2. "Energy Glow" chizish (Canvasda)
                const targetPoint = hand[activeLandmark];
                const glowX = targetPoint.x * handCanvas.width;
                const glowY = targetPoint.y * handCanvas.height;

                handCtx.beginPath();
                handCtx.arc(glowX, glowY, glowSize, 0, 2 * Math.PI);
                handCtx.fillStyle = glowColor;
                handCtx.shadowColor = glowColor;
                handCtx.shadowBlur = 30; // Nur effekti kuchi
                handCtx.fill();
                handCtx.shadowBlur = 0; // Reset
                
            } else {
                modeText.textContent = 'QO\'L KIRISHI KUTILMOQDA...';
            }
            handCtx.restore();
        }

        // Obyekt yaratish funksiyasi
        function createHolographicObject() {
            if (drawingPoints.length < 5) return;
            const shape = new THREE.Shape();
            shape.moveTo(drawingPoints[0].x, drawingPoints[0].y);
            drawingPoints.forEach(p => shape.lineTo(p.x, p.y));
            shape.closePath();

            const geometry = new THREE.ExtrudeGeometry(shape, { depth: 2, bevelEnabled: true, bevelThickness: 0.3, bevelSize: 0.2 });
            const dominantColor = drawingColors[Math.floor(drawingColors.length / 2)] || currentColor;
            const material = new THREE.MeshPhongMaterial({ 
                color: dominantColor, emissive: dominantColor, emissiveIntensity: 0.4,
                transparent: true, opacity: 0.9, shininess: 100
            });
            const mesh = new THREE.Mesh(geometry, material);
            
            geometry.computeBoundingBox();
            const center = new THREE.Vector3();
            geometry.boundingBox.getCenter(center);
            geometry.translate(-center.x, -center.y, -center.z);
            mesh.position.copy(center);
            
            scene.add(mesh);
            objects3D.push(mesh);
            
            // Tozalash
            drawingPoints = []; drawingColors = [];
            tempLines.forEach(l => scene.remove(l)); tempLines = [];
        }

        // Camera Setup
        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
        hands.onResults(onResults);

        const cam = new Camera(video, {
            onFrame: async () => await hands.send({ image: video }),
            width: 1280, height: 720
        });
        
        // Start
        setTimeout(() => {
            cam.start().then(() => {
                showNotification('Tizim tayyor');
                modeText.textContent = 'TIZIM FAOL';
            });
        }, 3500);

        // Animation Loop
        function animate() {
            requestAnimationFrame(animate);
            // Ushlanmagan obyektlar sekin aylanib tursin
            objects3D.forEach(obj => {
                if (obj !== grabbedObject) obj.rotation.y += 0.005;
            });
            renderer.render(scene, camera);
        }
        animate();

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            resizeCanvas();
        });

        // Particle System
        const particles = [];
        function animateParticles() {
            pCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);
            // Particle logikasi shu yerda bo'lishi mumkin (optimallashtirish uchun olib tashlandi, lekin canvas turibdi)
            requestAnimationFrame(animateParticles);
        }
        animateParticles();

    </script>
</body>
</html>
