<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>JARVIS Professional Artist Studio</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        /* --- ASOSIY STIL --- */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body {
            background: #121212;
            overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
            cursor: crosshair; /* Default Qalam/Nishon */
        }

        /* KURSORLAR LOGIKASI */
        body.hovering-paint { cursor: grab; }
        body.grabbing-paint { cursor: grabbing; }

        /* ORQAGA TUGMASI */
        .back-btn {
            position: fixed; top: 20px; left: 20px; padding: 8px 20px;
            background: rgba(255,255,255,0.1); border: 1px solid #00d4ff;
            color: #00d4ff; text-decoration: none; border-radius: 8px;
            backdrop-filter: blur(5px); z-index: 200; font-weight: bold;
            transition: 0.3s;
        }
        .back-btn:hover { background: rgba(0, 212, 255, 0.2); box-shadow: 0 0 15px #00d4ff; }

        /* GEMINI PROFIL (O'ng burchak) */
        .profile-card {
            position: fixed; top: 20px; right: 20px;
            display: flex; align-items: center; gap: 10px;
            background: rgba(30, 30, 30, 0.8); padding: 5px 15px 5px 5px;
            border-radius: 50px; border: 1px solid #444;
            z-index: 200; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .p-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #00d4ff; }
        .p-name { color: #fff; font-size: 14px; font-weight: 600; }

        /* --- KANVASLAR --- */
        #video { display: none; }
        #hand-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 50; }
        
        /* --- HUD --- */
        #status-bar {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); padding: 8px 20px; border-radius: 20px;
            color: #00d4ff; font-weight: bold; border: 1px solid #00d4ff;
            pointer-events: none; z-index: 100;
        }

        /* --- 1. RANG QUTILARI (PALITRA - Chap tomon) --- */
        #palette-shelf {
            position: fixed; top: 100px; right: 20px;
            width: 70px;
            display: flex; flex-direction: column; gap: 15px;
            z-index: 150;
            padding: 10px 0;
            align-items: center;
        }
        .paint-jar {
            width: 50px; height: 50px;
            border-radius: 10px;
            border: 3px solid #555;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8), 0 5px 10px rgba(0,0,0,0.5);
            cursor: grab; transition: 0.2s;
            position: relative;
        }
        .paint-jar:hover { transform: scale(1.1); border-color: #fff; }
        .paint-jar.active { border-color: #00d4ff; box-shadow: 0 0 15px #00d4ff; transform: scale(1.15); }
        
        /* Yangi rang qo'shish tugmasi */
        #add-color-zone {
            width: 50px; height: 50px; border: 2px dashed #777;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: #777; font-size: 24px; transition: 0.3s;
        }
        #add-color-zone.hovered { border-color: #00d4ff; color: #00d4ff; transform: scale(1.2); }

        /* --- 2. MIXER BOARD (Pastki qism - Haqiqiy Canvas) --- */
        #mixer-container {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 200px;
            z-index: 150; pointer-events: none; /* Events faqat ichidagi elementlarga */
            display: flex; justify-content: center; align-items: flex-end;
            padding-bottom: 20px; gap: 20px;
        }

        #mixing-canvas {
            width: 500px; height: 150px;
            background: #2a2a2a;
            border: 8px solid #4a3b2a; /* Yog'och ramka effekti */
            border-radius: 10px;
            cursor: crosshair;
            pointer-events: all;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        /* Latta */
        #rag {
            width: 80px; height: 80px;
            background: url('https://cdn-icons-png.flaticon.com/512/9163/9163013.png') no-repeat center/contain;
            pointer-events: all; cursor: pointer;
            transition: 0.3s; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
        }
        #rag:hover { transform: rotate(-10deg) scale(1.1); }
        #rag:active { transform: rotate(20deg) scale(0.9); }

        /* Bildirishnoma */
        #toast {
            position: fixed; top: 130px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 212, 255, 0.2); border: 1px solid #00d4ff;
            color: #fff; padding: 10px 20px; border-radius: 5px;
            opacity: 0; transition: 0.3s; z-index: 200; pointer-events: none;
        }
        #toast.show { opacity: 1; top: 120px; }

    </style>
</head>
<body>

    <script>if (!localStorage.getItem('atom_user')) { window.location.href = 'index.html'; }</script>

    <a href="dashboard.html" class="back-btn">‚Üê DASHBOARD</a>
    
    <div class="profile-card">
        <img id="u-img" class="p-img" src="">
        <span id="u-name" class="p-name">Artist</span>
    </div>

    <div id="status-bar">TIZIM TAYYOR</div>
    <div id="toast">Xabar</div>

    <video id="video"></video>
    <canvas id="hand-canvas"></canvas>

    <div id="palette-shelf">
        <div id="add-color-zone" title="Yangi rang uchun joy">+</div>
    </div>

    <div id="mixer-container">
        <canvas id="mixing-canvas" width="500" height="150"></canvas>
        <div id="rag" title="Tozalash" onclick="clearMixer()"></div>
    </div>

    <script>
        // --- 1. SETUP VA PROFIL ---
        window.onload = () => {
            const u = JSON.parse(localStorage.getItem('atom_user'));
            document.getElementById('u-img').src = u.picture || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
            document.getElementById('u-name').innerText = u.nickname || "Artist";
            
            initPalette();
            initMixer();
        }

        const notify = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }
        const statusText = document.getElementById('status-bar');

        // --- 2. RANG TIZIMI (REALISTIC PALETTE) ---
        let currentDrawColor = '#FF0000'; // Chizish rangi
        let baseColors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FFFFFF', '#000000'];
        let draggedColor = null;

        const paletteShelf = document.getElementById('palette-shelf');
        const addZone = document.getElementById('add-color-zone');

        function initPalette() {
            // Mavjud qutilarni tozalash (add-zone dan boshqasini)
            const oldJars = document.querySelectorAll('.paint-jar');
            oldJars.forEach(j => j.remove());

            baseColors.forEach(color => createPaintJar(color));
        }

        function createPaintJar(color) {
            const jar = document.createElement('div');
            jar.className = 'paint-jar';
            jar.style.backgroundColor = color;
            
            // Interaction
            jar.onclick = () => {
                currentDrawColor = color;
                document.querySelectorAll('.paint-jar').forEach(j => j.classList.remove('active'));
                jar.classList.add('active');
                notify("Rang tanlandi");
            };

            // Dragging Logic (Rangni olib qochish)
            jar.draggable = true;
            jar.ondragstart = (e) => {
                draggedColor = color;
                e.dataTransfer.effectAllowed = "copy";
                document.body.classList.add('grabbing-paint');
            };
            jar.ondragend = () => document.body.classList.remove('grabbing-paint');
            
            // Hover effects for cursor
            jar.onmouseenter = () => document.body.classList.add('hovering-paint');
            jar.onmouseleave = () => document.body.classList.remove('hovering-paint');

            paletteShelf.insertBefore(jar, addZone);
            
            // Agar bu yangi yaratilgan rang bo'lsa, uni active qilamiz
            if(color === currentDrawColor) jar.classList.add('active');
        }

        // Yangi rang qabul qilish zonasi
        addZone.ondragover = (e) => { e.preventDefault(); addZone.classList.add('hovered'); };
        addZone.ondragleave = () => addZone.classList.remove('hovered');
        addZone.ondrop = (e) => {
            e.preventDefault();
            addZone.classList.remove('hovered');
            if (draggedColor) {
                // Agar rang ro'yxatda bo'lmasa, qo'shamiz
                if (!baseColors.includes(draggedColor)) {
                    baseColors.push(draggedColor);
                    currentDrawColor = draggedColor; // Avtomatik tanlash
                    initPalette(); // Qayta chizish
                    notify("Yangi rang qutisi yaratildi!");
                }
            }
            draggedColor = null;
        };

        // --- 3. MIXER CANVAS (REALISTIC BLENDING) ---
        const mixCanvas = document.getElementById('mixing-canvas');
        const mixCtx = mixCanvas.getContext('2d', { willReadFrequently: true });
        let isPickingColor = false;

        function initMixer() {
            // Fonni tozalash
            mixCtx.fillStyle = '#2a2a2a';
            mixCtx.fillRect(0,0, 500, 150);
        }

        function clearMixer() {
            initMixer();
            // Latta animatsiyasi
            const r = document.getElementById('rag');
            r.style.transform = "translateX(-100px) rotate(-30deg)";
            setTimeout(() => r.style.transform = "none", 300);
            notify("Doska tozalandi");
        }

        // Drag & Drop to Mixer
        mixCanvas.ondragover = (e) => e.preventDefault();
        mixCanvas.ondrop = (e) => {
            e.preventDefault();
            if (!draggedColor) return;

            const rect = mixCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            drawPaintBlob(x, y, draggedColor);
            draggedColor = null;
        };

        function drawPaintBlob(x, y, color) {
            // Radial gradient bilan "to'kilgan bo'yoq" effekti
            const radius = 30;
            const grd = mixCtx.createRadialGradient(x, y, 0, x, y, radius);
            grd.addColorStop(0, color);
            grd.addColorStop(1, convertHexToRGBA(color, 0)); // Chetlar shaffof

            mixCtx.globalCompositeOperation = 'source-over'; // Ustiga chizish
            // Agar aralashtirishni xohlasak: 'screen' yoki 'multiply' ishlatish mumkin
            // Lekin eng realistik: shunchaki yarim shaffof qilib ustiga chizish
            mixCtx.globalAlpha = 0.8; 
            
            mixCtx.fillStyle = grd;
            mixCtx.beginPath();
            mixCtx.arc(x, y, radius, 0, Math.PI*2);
            mixCtx.fill();
            
            mixCtx.globalAlpha = 1.0;
        }

        // Click to Pick Mixed Color
        mixCanvas.onmousedown = (e) => {
            const rect = mixCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Piksel rangini o'qish
            const p = mixCtx.getImageData(x, y, 1, 1).data;
            // Agar fon rangi bo'lsa (bo'sh joy)
            if (p[0] === 42 && p[1] === 42 && p[2] === 42) return; // #2a2a2a fon
            
            const hex = rgbToHex(p[0], p[1], p[2]);
            currentDrawColor = hex;
            draggedColor = hex; // Sudrashga tayyorlash
            
            // Kursorga vaqtincha rang berish (Drag start simulyatsiyasi)
            notify("Rang olindi: " + hex);
            
            // Bu yerdan sudrab ketish mumkin qilish uchun:
            // HTML5 Drag API Canvas ichidan to'g'ridan to'g'ri ishlamaydi, 
            // shuning uchun biz "draggedColor" ni set qildik, endi user "Add Zone" ga borsa bo'ldi.
            // Lekin vizual tushunish uchun:
            document.body.style.cursor = "copy";
        };
        
        mixCanvas.onmouseup = () => { document.body.style.cursor = "crosshair"; };

        // Helpers
        function convertHexToRGBA(hex, alpha) {
            const r = parseInt(hex.slice(1,3), 16);
            const g = parseInt(hex.slice(3,5), 16);
            const b = parseInt(hex.slice(5,7), 16);
            return `rgba(${r},${g},${b},${alpha})`;
        }
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        // --- 4. THREE.JS (3D LOGIC) ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.insertBefore(renderer.domElement, document.body.firstChild);
        
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const dLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dLight.position.set(10, 20, 10);
        scene.add(dLight);
        camera.position.z = 25;

        // Variables
        let drawingPoints = [];
        let currentLine = null; // Hozir chizilayotgan chiziq
        let objects3D = [];
        let grabbedObject = null;
        let isPainting = false;
        let lastPaintPoint = null;

        // Raycaster for Painting
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // --- MOUSE PAINTING (Sichqoncha bilan bo'yash) ---
        window.addEventListener('mousedown', (e) => {
            // Agar canvas ustida bo'lsa, aralashmaymiz
            if(e.target.id === 'mixing-canvas' || e.target.classList.contains('paint-jar')) return;
            isPainting = true;
            paintOn3D(e);
        });
        window.addEventListener('mouseup', () => { isPainting = false; lastPaintPoint = null; });
        window.addEventListener('mousemove', (e) => { if(isPainting) paintOn3D(e); });

        function paintOn3D(e) {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(objects3D);

            if (intersects.length > 0) {
                const intersect = intersects[0];
                const point = intersect.point;
                const normal = intersect.face.normal;

                // Nuqta emas, chiziq (Interpolation) chizamiz
                if (lastPaintPoint) {
                    const dist = point.distanceTo(lastPaintPoint);
                    const steps = Math.ceil(dist / 0.05); // Zichlik
                    for(let i=0; i<=steps; i++) {
                        const t = i/steps;
                        const p = new THREE.Vector3().lerpVectors(lastPaintPoint, point, t);
                        
                        // Kichik sfera (bo'yoq)
                        const dotGeo = new THREE.SphereGeometry(0.12, 6, 6);
                        const dotMat = new THREE.MeshBasicMaterial({ color: currentDrawColor });
                        const dot = new THREE.Mesh(dotGeo, dotMat);
                        dot.position.copy(p).add(normal.clone().multiplyScalar(0.02)); // Sal teparoq
                        intersect.object.attach(dot); // Obyektga yopishtirish
                    }
                }
                lastPaintPoint = point.clone();
            } else {
                lastPaintPoint = null; // Obyekt tashqarisiga chiqsa uziladi
            }
        }

        // --- 5. HAND TRACKING LOGIC ---
        const handCanvas = document.getElementById('hand-canvas');
        const handCtx = handCanvas.getContext('2d');

        function onResults(results) {
            handCanvas.width = window.innerWidth;
            handCanvas.height = window.innerHeight;
            handCtx.clearRect(0, 0, handCanvas.width, handCanvas.height);
            
            handCtx.save();
            handCtx.translate(handCanvas.width, 0);
            handCtx.scale(-1, 1);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const hand = results.multiHandLandmarks[0];
                const index = hand[8];
                const thumb = hand[4];
                const middle = hand[12];
                const wrist = hand[0];

                // Coordinates
                const x = (1 - index.x) * window.innerWidth;
                const y = index.y * window.innerHeight;
                
                // 3D Space Coord
                const v3 = new THREE.Vector3(
                    (x / window.innerWidth - 0.5) * 45,
                    -(y / window.innerHeight - 0.5) * 35,
                    0
                );

                // GESTURES
                // 1. Fist (Musht)
                const isFist = hand[8].y > hand[6].y && hand[12].y > hand[10].y && hand[16].y > hand[14].y;
                
                // 2. Pinch (Chimshilash)
                const isPinching = !isFist && Math.hypot(index.x - thumb.x, index.y - thumb.y) < 0.08;
                
                // 3. Pointing (Chizish)
                const isPointing = !isFist && !isPinching && hand[8].y < hand[6].y && hand[12].y > hand[10].y;
                
                // 4. Open Hand (Yaratish)
                const isOpen = !isFist && !isPinching && !isPointing;

                let skelColor = '#00d4ff';

                if (isFist) {
                    statusText.innerText = "MUSHT: AYLANTIRISH (ROTATE)";
                    skelColor = '#ff00ff';
                    
                    if (!grabbedObject) {
                        // Find object
                        for(let obj of objects3D) {
                            if (v3.distanceTo(obj.position) < 8) {
                                grabbedObject = obj;
                                notify("Obyekt aylantirish uchun ushlandi"); break;
                            }
                        }
                    }
                    if (grabbedObject) {
                        // Qo'lning holatiga qarab aylantirish (Tilt control)
                        // Bilak va barmoq orasidagi masofaga qarab emas, shunchaki harakatga qarab
                        grabbedObject.rotation.y += (index.x - 0.5) * 0.2;
                        grabbedObject.rotation.x += (index.y - 0.5) * 0.2;
                    }
                }
                else if (isPinching) {
                    statusText.innerText = "CHIMSHILASH: KO'CHIRISH (MOVE)";
                    skelColor = '#00ffff';
                    
                    if (!grabbedObject) {
                        for(let obj of objects3D) {
                            if (v3.distanceTo(obj.position) < 6) {
                                grabbedObject = obj; 
                                notify("Ko'chirish uchun ushlandi"); break;
                            }
                        }
                    } else {
                        // Move
                        grabbedObject.position.lerp(v3, 0.2);
                    }
                }
                else if (isPointing) {
                    statusText.innerText = "CHIZISH...";
                    skelColor = currentDrawColor;
                    grabbedObject = null; // Qo'yib yuborish

                    drawingPoints.push(v3.clone());

                    // Live chiziq chizish (Visual)
                    if (drawingPoints.length > 1) {
                        const last = drawingPoints[drawingPoints.length-2];
                        if (last.distanceTo(v3) > 0.1) {
                            // Three.js Line yaratamiz vaqtinchalik
                            const mat = new THREE.LineBasicMaterial({ color: currentDrawColor, linewidth: 5 });
                            const geo = new THREE.BufferGeometry().setFromPoints([last, v3]);
                            const line = new THREE.Line(geo, mat);
                            scene.add(line);
                            // Buni arrayga saqlash shart emas, chunki final mesh "Shape" dan yasaladi
                            // Faqat vizual uchun saqlab turamiz tozalashga
                            if(!currentLine) currentLine = [];
                            currentLine.push(line);
                        }
                    }
                }
                else if (isOpen && drawingPoints.length > 5) {
                    statusText.innerText = "3D OBYEKT YARATISH";
                    createFinalObject();
                    notify("Yangi 3D obyekt yaratildi!");
                }
                else {
                    statusText.innerText = "KUTISH...";
                    grabbedObject = null;
                }

                // Chizish (Skelet)
                drawConnectors(handCtx, hand, HAND_CONNECTIONS, {color: skelColor, lineWidth: 3});
                drawLandmarks(handCtx, hand, {color: '#fff', radius: 3});
            }
            handCtx.restore();
        }

        function createFinalObject() {
            if (drawingPoints.length < 5) return;

            const shape = new THREE.Shape();
            shape.moveTo(drawingPoints[0].x, drawingPoints[0].y);
            for(let i=1; i<drawingPoints.length; i++) {
                shape.lineTo(drawingPoints[i].x, drawingPoints[i].y);
            }
            
            const extrudeSettings = { depth: 2, bevelEnabled: true, bevelThickness: 0.5, bevelSize: 0.3, segments: 2 };
            const geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
            
            // MUHIM: Obyekt rangi tanlangan rangda bo'ladi
            const material = new THREE.MeshPhongMaterial({ 
                color: currentDrawColor, 
                shininess: 80,
                specular: 0x111111
            });
            
            const mesh = new THREE.Mesh(geometry, material);
            
            // Markazga keltirish
            geometry.computeBoundingBox();
            const center = new THREE.Vector3();
            geometry.boundingBox.getCenter(center);
            geometry.translate(-center.x, -center.y, -center.z);
            mesh.position.copy(center);

            scene.add(mesh);
            objects3D.push(mesh);

            // Tozalash
            drawingPoints = [];
            // Vaqtinchalik chiziqlarni o'chirish
            if(currentLine) {
                currentLine.forEach(l => scene.remove(l));
                currentLine = null;
            }
        }

        // --- INIT ---
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.75, minTrackingConfidence: 0.75});
        hands.onResults(onResults);

        const videoEl = document.getElementById('video');
        const cam = new Camera(videoEl, {
            onFrame: async () => await hands.send({image: videoEl}),
            width: 1280, height: 720
        });
        cam.start();

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        window.onresize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            handCanvas.width = window.innerWidth;
            handCanvas.height = window.innerHeight;
        };

    </script>
</body>
</html>
