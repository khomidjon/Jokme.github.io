<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS Art Studio Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif; /* Zamonaviyroq font */
            background: #000;
            overflow: hidden;
            color: #fff;
        }

        /* 1. GEMINI STYLE PROFILE (O'ng burchak) */
        .profile-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(30, 30, 40, 0.6);
            backdrop-filter: blur(10px);
            padding: 8px 15px 8px 20px;
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10001;
            transition: 0.3s;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .profile-badge:hover {
            background: rgba(40, 40, 60, 0.8);
            border-color: #00d4ff;
            transform: translateY(-2px);
        }
        .profile-name {
            font-size: 14px;
            font-weight: 600;
            color: #e0e0e0;
            letter-spacing: 0.5px;
        }
        .profile-img-box {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.4);
        }
        .profile-img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 2. ORQAGA TUGMASI */
        .back-btn {
            position: fixed; top: 20px; left: 20px; padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(0, 212, 255, 0.3);
            color: #00d4ff; text-decoration: none; z-index: 10000;
            border-radius: 8px; backdrop-filter: blur(5px);
            transition: 0.3s; font-weight: bold; font-size: 14px;
            display: flex; align-items: center; gap: 8px;
        }
        .back-btn:hover { background: rgba(0, 212, 255, 0.15); border-color: #00d4ff; }

        /* INTRO SCREEN */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex;
            justify-content: center; align-items: center;
            transition: opacity 1s ease-out;
        }
        #intro-text { font-family: 'Courier New', monospace; font-size: 40px; color: #00d4ff; text-shadow: 0 0 20px #00d4ff; }

        /* CANVASLAR */
        #video { display: none; }
        #hand-canvas, #particle-canvas { position: fixed; top: 0; left: 0; pointer-events: none; }
        #hand-canvas { z-index: 15; }
        #particle-canvas { z-index: 5; }

        /* HUD & STATUS */
        #hud-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        #status-panel {
            position: absolute; top: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7); border: 1px solid #00d4ff;
            padding: 10px 25px; border-radius: 20px; text-align: center;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        #jarvis-text { font-size: 20px; font-weight: bold; color: #fff; }
        #mode-text { font-size: 12px; color: #00d4ff; margin-top: 3px; letter-spacing: 1px; }

        /* 3. YANGILANGAN RANG PALITRASI (Scroll & Mix) */
        #palette-container {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 30, 0.9);
            padding: 10px 20px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; gap: 15px;
            z-index: 20; pointer-events: all;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 90vw;
        }

        /* Ranglar ro'yxati (Scroll bo'ladi) */
        #colors-scroll {
            display: flex; gap: 10px; overflow-x: auto; 
            padding: 5px; max-width: 60vw;
            scrollbar-width: none; /* Firefox */
        }
        #colors-scroll::-webkit-scrollbar { display: none; } /* Chrome */

        .color-btn {
            width: 35px; height: 35px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.2);
            cursor: pointer; transition: 0.2s; flex-shrink: 0;
        }
        .color-btn:hover { transform: scale(1.15); border-color: #fff; }
        .color-btn.active { border: 3px solid #fff; box-shadow: 0 0 15px currentColor; transform: scale(1.1); }

        /* Color Mixer (Yangi rang qo'shish) */
        .mixer-section {
            display: flex; align-items: center; gap: 10px;
            padding-left: 15px; border-left: 1px solid rgba(255,255,255,0.2);
        }
        #color-input {
            width: 35px; height: 35px; border: none; background: none; cursor: pointer;
            padding: 0; border-radius: 50%; overflow: hidden;
        }
        #add-color-btn {
            background: linear-gradient(135deg, #00d4ff, #0051ff);
            border: none; color: white; width: 35px; height: 35px;
            border-radius: 50%; font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s;
        }
        #add-color-btn:hover { transform: rotate(90deg); box-shadow: 0 0 15px #00d4ff; }

        /* Notification */
        #notification {
            position: absolute; top: 120px; right: 20px;
            background: rgba(0, 0, 0, 0.8); border-left: 4px solid #00d4ff;
            padding: 15px; border-radius: 5px; opacity: 0; transform: translateX(50px);
            transition: 0.4s; font-family: monospace;
        }
        #notification.show { opacity: 1; transform: translateX(0); }

    </style>
</head>
<body>

    <script>
        if (!localStorage.getItem('atom_user')) { window.location.href = 'index.html'; }
    </script>

    <a href="dashboard.html" class="back-btn">
        <span>‚Üê</span> DASHBOARD
    </a>

    <div class="profile-badge" onclick="window.location.href='profil.html'">
        <div class="profile-name" id="display-name">Foydalanuvchi</div>
        <div class="profile-img-box">
            <img id="display-img" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="Profile">
        </div>
    </div>

    <div id="intro-screen">
        <div id="intro-text">JARVIS ART STUDIO...</div>
    </div>

    <video id="video"></video>
    <canvas id="hand-canvas"></canvas>
    
    <div id="hud-overlay">
        <div id="status-panel">
            <div id="jarvis-text">JARVIS AI</div>
            <div id="mode-text">TIZIM YUKLANMOQDA...</div>
        </div>
        <div id="notification"></div>
    </div>

    <div id="palette-container">
        <div class="color-btn" id="eraser-tool" style="background: #333; display: flex; align-items: center; justify-content: center; font-size: 18px;">üóëÔ∏è</div>
        
        <div id="colors-scroll">
            </div>

        <div class="mixer-section">
            <input type="color" id="color-input" value="#ff0000" title="Rang tanlash">
            <button id="add-color-btn" onclick="addNewColor()" title="Rangni palitraga qo'shish">+</button>
        </div>
    </div>

    <script>
        // --- SETUP ---
        setTimeout(() => {
            const intro = document.getElementById('intro-screen');
            intro.style.opacity = '0';
            setTimeout(() => intro.style.display = 'none', 1000);
        }, 2000);

        // --- PROFIL MA'LUMOTLARINI YUKLASH ---
        window.onload = function() {
            const userStr = localStorage.getItem('atom_user');
            if (userStr) {
                const u = JSON.parse(userStr);
                document.getElementById('display-name').innerText = u.nickname || u.name || "Foydalanuvchi";
                if(u.picture) document.getElementById('display-img').src = u.picture;
            }
            initPalette(); // Ranglarni ishga tushirish
        };

        // --- VARIABLES ---
        const video = document.getElementById('video');
        const handCanvas = document.getElementById('hand-canvas');
        const handCtx = handCanvas.getContext('2d');
        const modeText = document.getElementById('mode-text');
        const notification = document.getElementById('notification');
        
        // Canvas Resize
        function resize() {
            handCanvas.width = window.innerWidth;
            handCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- COLOR MIXER LOGIC ---
        let currentColor = '#FF0000';
        let isEraser = false;
        // Boshlang'ich ranglar
        const defaultColors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#00FFFF', '#FF00FF', '#FFFFFF'];

        function initPalette() {
            const scrollBox = document.getElementById('colors-scroll');
            scrollBox.innerHTML = ''; // Tozalash
            
            defaultColors.forEach(color => createColorBtn(color));
            
            // O'chirg'ich logikasi
            document.getElementById('eraser-tool').onclick = function() {
                activateColor(this, true);
            };
            // Birinchi rangni aktiv qilish
            if(scrollBox.children.length > 0) activateColor(scrollBox.children[0], false, defaultColors[0]);
        }

        function createColorBtn(color) {
            const btn = document.createElement('div');
            btn.className = 'color-btn';
            btn.style.backgroundColor = color;
            btn.onclick = () => activateColor(btn, false, color);
            document.getElementById('colors-scroll').appendChild(btn);
            return btn;
        }

        function addNewColor() {
            const newColor = document.getElementById('color-input').value;
            const btn = createColorBtn(newColor);
            // Yangi qo'shilgan rangni darhol tanlaymiz
            activateColor(btn, false, newColor);
            // Scrollni oxiriga o'tkazish
            const scrollBox = document.getElementById('colors-scroll');
            scrollBox.scrollLeft = scrollBox.scrollWidth;
            showNotification(`Yangi rang qo'shildi: ${newColor}`);
        }

        function activateColor(element, eraserMode, colorCode) {
            // Hamma tugmalardan active ni olib tashlash
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('eraser-tool').classList.remove('active');
            
            element.classList.add('active');
            isEraser = eraserMode;
            
            if (!eraserMode) {
                currentColor = colorCode;
            }
        }

        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.insertBefore(renderer.domElement, document.body.firstChild);
        
        scene.add(new THREE.AmbientLight(0x404040, 2));
        const pLight = new THREE.PointLight(0x00d4ff, 2, 100);
        pLight.position.set(0, 10, 10);
        scene.add(pLight);
        camera.position.z = 25;

        // --- LOGIC VARS ---
        let drawingPoints = [];
        let drawingColors = [];
        let tempLines = [];
        let objects3D = [];
        let grabbedObject = null;
        let currentLayerZ = 0; // Layering uchun

        function showNotification(text) {
            notification.innerText = text;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 2000);
        }

        // --- HAND TRACKING LOOP ---
        function onResults(results) {
            handCtx.clearRect(0, 0, handCanvas.width, handCanvas.height);
            handCtx.save();
            handCtx.translate(handCanvas.width, 0);
            handCtx.scale(-1, 1);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const hand = results.multiHandLandmarks[0];
                const indexTip = hand[8];
                const thumbTip = hand[4];

                // Koordinatalar (Full Screen Mapping)
                const screenX = (1 - indexTip.x) * window.innerWidth;
                const screenY = indexTip.y * window.innerHeight;
                
                // 3D olamga o'tkazish
                const x = (screenX / window.innerWidth - 0.5) * 45; 
                const y = -(screenY / window.innerHeight - 0.5) * 35; 
                const pos = new THREE.Vector3(x, y, 0);

                // --- GESTURES ---
                // 1. Musht (Fist) -> Aylantirish
                const isFist = (hand[8].y > hand[6].y && hand[12].y > hand[10].y && hand[16].y > hand[14].y && hand[20].y > hand[18].y);
                // 2. Pinch -> Ko'chirish
                const isPinching = !isFist && (Math.hypot(indexTip.x - thumbTip.x, indexTip.y - thumbTip.y) < 0.1);
                // 3. Pointing -> Chizish
                const isPointing = !isFist && !isPinching && (hand[8].y < hand[6].y && hand[12].y > hand[10].y);
                // 4. Open Hand -> Yaratish
                const isOpenHand = !isFist && !isPinching && (hand[8].y < hand[6].y && hand[12].y < hand[10].y && hand[16].y < hand[14].y);

                let skeletonColor = '#00d4ff';
                let glowColor = '#fff';
                let activePoint = hand[8]; // Default index tip

                if (isFist) {
                    // --- REJIM: AYLANTIRISH ---
                    modeText.innerText = "MUSHT: AYLANTIRISH";
                    skeletonColor = '#FF00FF'; glowColor = '#FF00FF';
                    activePoint = hand[9]; // O'rta bo'g'im

                    if (!grabbedObject) {
                        for(let obj of objects3D) {
                            if (pos.distanceTo(obj.position) < 8) {
                                grabbedObject = obj; showNotification("Obyekt tanlandi"); break;
                            }
                        }
                    }
                    if (grabbedObject) {
                        grabbedObject.rotation.y = (indexTip.x - 0.5) * 6;
                        grabbedObject.rotation.x = (indexTip.y - 0.5) * 6;
                    }

                } else if (isPinching) {
                    // --- REJIM: KO'CHIRISH / O'CHIRISH ---
                    if (isEraser) {
                        modeText.innerText = "OCHIRG'ICH";
                        skeletonColor = '#FF0000'; glowColor = '#FF0000';
                        // O'chirish logikasi (Hamma rangdagi obyektlarni o'chiradi)
                        for(let i = objects3D.length-1; i>=0; i--) {
                            if (pos.distanceTo(objects3D[i].position) < 5) {
                                scene.remove(objects3D[i]); objects3D.splice(i, 1);
                                showNotification("Obyekt o'chirildi"); break;
                            }
                        }
                    } else {
                        modeText.innerText = "KO'CHIRISH";
                        skeletonColor = '#00FFFF'; glowColor = '#00FFFF';
                        if (!grabbedObject) {
                            for(let obj of objects3D) {
                                if (pos.distanceTo(obj.position) < 6) {
                                    grabbedObject = obj; showNotification("Ushlandi"); break;
                                }
                            }
                        } else {
                            // Faqat X va Y o'zgaradi, Z joyida qoladi
                            grabbedObject.position.x = THREE.MathUtils.lerp(grabbedObject.position.x, pos.x, 0.2);
                            grabbedObject.position.y = THREE.MathUtils.lerp(grabbedObject.position.y, pos.y, 0.2);
                        }
                    }

                } else if (isPointing) {
                    // --- REJIM: CHIZISH ---
                    modeText.innerText = "CHIZISH";
                    skeletonColor = '#FFA500'; glowColor = currentColor;
                    grabbedObject = null;

                    drawingPoints.push(pos.clone());
                    drawingColors.push(currentColor);

                    if (drawingPoints.length > 1) {
                        const last = drawingPoints[drawingPoints.length-2];
                        if (last.distanceTo(pos) > 0.1) {
                            const geo = new THREE.CylinderGeometry(0.12, 0.12, last.distanceTo(pos), 6);
                            const mat = new THREE.MeshBasicMaterial({ color: currentColor });
                            const line = new THREE.Mesh(geo, mat);
                            line.position.copy(last).lerp(pos, 0.5);
                            line.lookAt(pos); line.rotateX(Math.PI/2);
                            scene.add(line);
                            tempLines.push(line);
                        }
                    }

                } else if (isOpenHand && drawingPoints.length > 5) {
                    // --- REJIM: YARATISH ---
                    modeText.innerText = "3D OBYEKT YARATILDI";
                    createHologram();
                    showNotification("Yangi 3D San'at!");
                    skeletonColor = '#00FF00'; glowColor = '#00FF00';

                } else {
                    modeText.innerText = "KUTISH REJIMI";
                    grabbedObject = null;
                }

                // --- VISUALIZATSIYA ---
                drawConnectors(handCtx, hand, HAND_CONNECTIONS, {color: skeletonColor, lineWidth: 2});
                drawLandmarks(handCtx, hand, {color: skeletonColor, radius: 2});

                // NUR (GLOW)
                const gX = (1 - activePoint.x) * handCanvas.width;
                const gY = activePoint.y * handCanvas.height;
                
                handCtx.beginPath();
                handCtx.arc(gX, gY, 15, 0, 2*Math.PI);
                handCtx.fillStyle = glowColor;
                handCtx.shadowBlur = 20; handCtx.shadowColor = glowColor;
                handCtx.fill();
                handCtx.shadowBlur = 0;

            } else {
                modeText.innerText = "QO'L KO'RINMAYAPTI";
            }
            handCtx.restore();
        }

        function createHologram() {
            if (drawingPoints.length < 5) return;
            const shape = new THREE.Shape();
            shape.moveTo(drawingPoints[0].x, drawingPoints[0].y);
            drawingPoints.forEach(p => shape.lineTo(p.x, p.y));
            
            const geometry = new THREE.ExtrudeGeometry(shape, { depth: 2, bevelEnabled: true, bevelThickness:0.2, bevelSize:0.1 });
            // Dominant rangni olamiz
            const domColor = drawingColors[Math.floor(drawingColors.length/2)];
            const material = new THREE.MeshPhongMaterial({ color: domColor, transparent: true, opacity: 0.9 });
            const mesh = new THREE.Mesh(geometry, material);
            
            // Markazlash
            geometry.computeBoundingBox();
            const center = new THREE.Vector3();
            geometry.boundingBox.getCenter(center);
            geometry.translate(-center.x, -center.y, -center.z);
            mesh.position.copy(center);
            
            // Layering (Yangi obyekt orqaga ketadi)
            currentLayerZ -= 1;
            mesh.position.z = currentLayerZ;

            scene.add(mesh);
            objects3D.push(mesh);
            
            // Tozalash
            drawingPoints=[]; drawingColors=[];
            tempLines.forEach(l => scene.remove(l)); tempLines=[];
        }

        // --- INIT CAMERA ---
        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
        hands.onResults(onResults);

        const cam = new Camera(video, {
            onFrame: async () => await hands.send({ image: video }),
            width: 1280, height: 720
        });
        
        cam.start().then(() => {
            showNotification("Kameraga ulandi");
            modeText.innerText = "TAYYOR";
        });

        // Animation Loop
        function animate() {
            requestAnimationFrame(animate);
            objects3D.forEach(obj => {
                if(obj !== grabbedObject) obj.rotation.y += 0.005;
            });
            renderer.render(scene, camera);
        }
        animate();

    </script>
</body>
</html>
