<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>JARVIS - DEEP SPACE</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', Courier, monospace; }
        
        /* BOSHQARUV PANELÄ° (HUD) */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; user-select: none;
        }
        #info-box {
            position: absolute; top: 20px; right: 20px;
            text-align: right; color: #00ffea; text-shadow: 0 0 5px #00ffea;
            background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px;
        }
        #center-target {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 20px; height: 20px; border: 1px solid rgba(0, 255, 234, 0.3); border-radius: 50%;
        }
        #planet-label {
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            text-align: center; color: white; opacity: 0; transition: opacity 0.5s;
        }
        #planet-name { font-size: 40px; font-weight: bold; letter-spacing: 5px; text-shadow: 0 0 20px white; }
        #planet-dist { font-size: 18px; color: cyan; }

        /* KIRISH EKRANI */
        #menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.85); color: white; z-index: 1000; cursor: pointer;
        }
        .key { color: #000; background: #00ffea; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        
        /* XATOLIK EKRANI */
        #error-log {
            position: absolute; top: 0; left: 0; width: 100%; padding: 20px;
            color: red; font-family: monospace; pointer-events: none; z-index: 2000; display: none;
        }
    </style>
</head>
<body>

    <div id="error-log"></div>

    <div id="menu">
        <h1 style="color: #00ffea; text-shadow: 0 0 30px #00ffea; font-size: 50px;">JARVIS SPACE ENGINE</h1>
        <p style="font-size: 20px;">SIMULYATSIYANI BOSHLASH UCHUN BOSING</p>
        <br>
        <p><span class="key">W</span> <span class="key">A</span> <span class="key">S</span> <span class="key">D</span> - Dvigatel</p>
        <p><span class="key">SPACE</span> - Tepaga | <span class="key">CTRL</span> - Pastga</p>
        <p><span class="key">SHIFT</span> - GIPER-TEZLIK (20x)</p>
        <p><span class="key">G'ILDIRAK</span> - Vaqtni boshqarish</p>
    </div>

    <div id="hud">
        <div id="center-target"></div>
        <div id="info-box">
            <div id="time-display">VAQT: Real</div>
            <div id="speed-display">Tezlik: 0 km/s</div>
        </div>
        <div id="planet-label">
            <div id="planet-name">YER</div>
            <div id="planet-dist">Masofa: 0 km</div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- XATOLARNI USHLASH ---
        window.onerror = function(message, source, lineno, colno, error) {
            const el = document.getElementById('error-log');
            el.style.display = 'block';
            el.innerHTML += `XATO: ${message} <br> (Agar bu yozuv chiqsa, faylni oddiy ochgansiz. Iltimos, VS Code Live Server ishlating yoki konsolni ko'ring)<br>`;
        };

        let camera, scene, renderer, controls;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, moveUp = false, moveDown = false;
        let speedMultiplier = 1;
        let timeScale = 1;
        
        const planets = [];
        const textureLoader = new THREE.TextureLoader();
        let labelDiv = document.getElementById('planet-label');

        init();
        animate();

        function init() {
            try {
                // 1. SAHNA
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x000000); // Qop-qora koinot
                scene.fog = new THREE.FogExp2(0x000000, 0.00002);

                // 2. KAMERA
                camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000000);
                camera.position.set(0, 0, 400); // Boshlanish nuqtasi

                // 3. RENDERER
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                document.body.appendChild(renderer.domElement);

                // 4. NAZORAT (BOSHQARUV)
                controls = new PointerLockControls(camera, document.body);
                const menu = document.getElementById('menu');

                // CLICK MUAMMOSI YECHIMI:
                menu.addEventListener('click', () => {
                    controls.lock();
                });

                controls.addEventListener('lock', () => { menu.style.display = 'none'; });
                controls.addEventListener('unlock', () => { menu.style.display = 'flex'; });

                // 5. KLAVIATURA
                document.addEventListener('keydown', onKeyDown);
                document.addEventListener('keyup', onKeyUp);
                document.addEventListener('wheel', onScroll);

                // 6. YORUG'LIK
                // Quyosh nuri (Asosiy)
                const sunLight = new THREE.PointLight(0xffffff, 2, 20000);
                sunLight.position.set(0, 0, 0);
                sunLight.castShadow = true;
                sunLight.shadow.mapSize.width = 2048;
                sunLight.shadow.mapSize.height = 2048;
                scene.add(sunLight);
                
                // Tun tomonini ozgina yoritish (juda qorong'u bo'lmasligi uchun)
                scene.add(new THREE.AmbientLight(0x050505)); 

                // 7. OBEKTLAR
                createStars();
                createSun();
                createSolarSystem();

                window.addEventListener('resize', onWindowResize);
            } catch (e) {
                document.getElementById('error-log').innerText = "INIT XATOSI: " + e.message;
                document.getElementById('error-log').style.display = 'block';
            }
        }

        function createStars() {
            const starGeo = new THREE.BufferGeometry();
            const count = 20000;
            const positions = new Float32Array(count * 3);
            for(let i=0; i<count*3; i++) {
                positions[i] = (Math.random() - 0.5) * 50000;
            }
            starGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const starMat = new THREE.PointsMaterial({color: 0xffffff, size: 0.7, sizeAttenuation: false}); // Yulduzlar uzoqlashsa ham ko'rinadi
            const stars = new THREE.Points(starGeo, starMat);
            scene.add(stars);
        }

        function createSun() {
            // Olovli Quyosh
            const geometry = new THREE.SphereGeometry(60, 64, 64);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0xffaa00,
                map: loadTex('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/lava/lavatile.jpg')
            });
            const sun = new THREE.Mesh(geometry, material);
            
            // Glow (Nur effekti)
            const spriteMat = new THREE.SpriteMaterial({ 
                map: loadTex('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/sprites/glow.png'), 
                color: 0xffaa00, 
                transparent: true, 
                blending: THREE.AdditiveBlending 
            });
            const sprite = new THREE.Sprite(spriteMat);
            sprite.scale.set(300, 300, 1);
            sun.add(sprite);

            scene.add(sun);
        }

        function createSolarSystem() {
            // YER (Maxsus HD)
            createEarth();

            // Boshqa sayyoralar
            const data = [
                { name: "Merkuriy", size: 4, dist: 100, speed: 0.04, color: 0xaaaaaa },
                { name: "Venera", size: 9, dist: 150, speed: 0.03, color: 0xe6b800 },
                { name: "Mars", size: 5, dist: 300, speed: 0.018, color: 0xff3300 },
                { name: "Yupiter", size: 30, dist: 500, speed: 0.008, color: 0xd9b38c },
                { name: "Saturn", size: 25, dist: 750, speed: 0.006, color: 0xf4d19f, ring: true },
                { name: "Uran", size: 12, dist: 950, speed: 0.004, color: 0x66ccff },
                { name: "Neptun", size: 12, dist: 1100, speed: 0.003, color: 0x3333ff }
            ];

            data.forEach(p => {
                const geo = new THREE.SphereGeometry(p.size, 64, 64);
                const mat = new THREE.MeshStandardMaterial({ 
                    color: p.color,
                    roughness: 0.8
                });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.castShadow = true;
                mesh.receiveShadow = true;

                // Saturn halqasi
                if(p.ring) {
                    const ringGeo = new THREE.RingGeometry(p.size + 5, p.size + 15, 64);
                    const ringMat = new THREE.MeshBasicMaterial({ color: 0xcfb593, side: THREE.DoubleSide, transparent: true, opacity: 0.7 });
                    const ring = new THREE.Mesh(ringGeo, ringMat);
                    ring.rotation.x = Math.PI / 2;
                    mesh.add(ring);
                }

                planets.push({ mesh: mesh, dist: p.dist, speed: p.speed, angle: Math.random() * 10, name: p.name });
                scene.add(mesh);
            });
        }

        function createEarth() {
            // 1. Yer Shari
            const earthGeo = new THREE.SphereGeometry(10, 64, 64);
            const earthMat = new THREE.MeshPhongMaterial({
                map: loadTex('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_atmos_2048.jpg'),
                specularMap: loadTex('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_specular_2048.jpg'),
                specular: new THREE.Color('grey'),
                shininess: 10
            });
            const earth = new THREE.Mesh(earthGeo, earthMat);
            earth.castShadow = true;
            earth.receiveShadow = true;

            // 2. Bulutlar
            const cloudGeo = new THREE.SphereGeometry(10.2, 64, 64);
            const cloudMat = new THREE.MeshPhongMaterial({
                map: loadTex('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_clouds_1024.png'),
                side: THREE.DoubleSide,
                opacity: 0.8,
                transparent: true,
                depthWrite: false,
            });
            const clouds = new THREE.Mesh(cloudGeo, cloudMat);
            earth.add(clouds);

            // 3. Tungi chiroqlar (Oddiy usul: Emissive ishlatamiz)
            // Afsuski, murakkab shaderlarsiz tunni ajratish qiyin, lekin bulutlar realizm beradi.

            planets.push({ mesh: earth, dist: 200, speed: 0.02, angle: 0, name: "YER", rotateSelf: true, clouds: clouds });
            scene.add(earth);
        }

        // Xavfsiz tekstura yuklovchi
        function loadTex(url) {
            const tex = textureLoader.load(url);
            tex.colorSpace = THREE.SRGBColorSpace;
            return tex;
        }

        function onKeyDown(event) {
            switch (event.code) {
                case 'KeyW': moveForward = true; break;
                case 'KeyA': moveLeft = true; break;
                case 'KeyS': moveBackward = true; break;
                case 'KeyD': moveRight = true; break;
                case 'Space': moveUp = true; break;
                case 'ControlLeft': moveDown = true; break;
                case 'ShiftLeft': speedMultiplier = 20; break;
            }
        }

        function onKeyUp(event) {
            switch (event.code) {
                case 'KeyW': moveForward = false; break;
                case 'KeyA': moveLeft = false; break;
                case 'KeyS': moveBackward = false; break;
                case 'KeyD': moveRight = false; break;
                case 'Space': moveUp = false; break;
                case 'ControlLeft': moveDown = false; break;
                case 'ShiftLeft': speedMultiplier = 1; break;
            }
        }

        function onScroll(event) {
            if(event.deltaY < 0) timeScale *= 1.2;
            else timeScale /= 1.2;
            document.getElementById('time-display').innerText = `VAQT: ${timeScale.toFixed(1)}x`;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            // Sayyoralar harakati
            planets.forEach(p => {
                p.angle += p.speed * 0.1 * timeScale;
                p.mesh.position.x = Math.cos(p.angle) * p.dist;
                p.mesh.position.z = Math.sin(p.angle) * p.dist;
                
                // O'z o'qi atrofida
                p.mesh.rotation.y += 0.005 * timeScale;
                if(p.clouds) p.clouds.rotation.y += 0.007 * timeScale;
            });

            // Uchish (Fly Controls)
            if (controls.isLocked) {
                const delta = 0.5 * speedMultiplier;

                if (moveForward) controls.moveForward(delta);
                if (moveBackward) controls.moveForward(-delta);
                if (moveRight) controls.moveRight(delta);
                if (moveLeft) controls.moveRight(-delta);
                if (moveUp) camera.position.y += delta;
                if (moveDown) camera.position.y -= delta;
            }

            // UI: Masofa o'lchash
            let nearest = null;
            let minDist = Infinity;
            planets.forEach(p => {
                const d = camera.position.distanceTo(p.mesh.position);
                if(d < minDist) { minDist = d; nearest = p; }
            });

            if(nearest && minDist < 200) {
                labelDiv.style.opacity = 1;
                document.getElementById('planet-name').innerText = nearest.name;
                // Haqiqiyroq masofa (1 unit = 1000km deb olamiz)
                document.getElementById('planet-dist').innerText = `Masofa: ${Math.floor(minDist * 1000)} km`;
            } else {
                labelDiv.style.opacity = 0;
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
