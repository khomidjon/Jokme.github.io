<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atom - Galaxy AI</title>
    <style>
        /* --- ASOSIY STYLE --- */
        * { cursor: none !important; margin: 0; padding: 0; box-sizing: border-box; }
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: #fff; }

        /* --- GLASS KURSOR --- */
        #glass-cursor {
            position: fixed; top: 0; left: 0; width: 30px; height: 30px; border-radius: 50%;
            background: rgba(0, 210, 255, 0.1); backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 210, 255, 0.4); box-shadow: 0 0 10px rgba(0, 210, 255, 0.3);
            pointer-events: none; z-index: 99999; transform: translate(-50%, -50%);
            transition: width 0.2s, height 0.2s, background 0.2s;
        }
        #glass-cursor.hovered { width: 50px; height: 50px; background: rgba(0, 210, 255, 0.2); box-shadow: 0 0 20px #00d2ff; }
        #glass-cursor.clicked { transform: translate(-50%, -50%) scale(0.8); background: rgba(0, 210, 255, 0.6); }

        /* --- PROFIL --- */
        .profile-container {
            position: fixed; top: 25px; left: 25px; z-index: 10001;
            display: flex; align-items: center; gap: 10px;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            padding: 8px 15px; border-radius: 30px; border: 1px solid rgba(255, 255, 255, 0.2);
            transition: 0.3s; pointer-events: auto;
        }
        .profile-container:hover { background: rgba(255, 255, 255, 0.2); transform: scale(1.05); }
        .profile-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #00d2ff; }
        .profile-name { font-weight: bold; font-size: 14px; color: #fff; text-transform: uppercase; }

        /* --- INTRO SCREEN --- */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 9999; display: flex;
            justify-content: center; align-items: center; transition: opacity 1s ease-out;
        }
        .intro-content { display: flex; align-items: center; gap: 30px; }
        #edge-logo { width: 120px; animation: spinIn 1.5s forwards, glowBlue 2s infinite alternate; }
        #intro-text { font-size: 50px; font-weight: bold; color: #00d2ff; text-shadow: 0 0 15px #00d2ff; opacity: 0; transform: translateX(-50px); animation: slideInText 1s forwards 1.2s; }

        @keyframes spinIn { 0% { transform: rotate(0deg) scale(0); opacity: 0; } 100% { transform: rotate(720deg) scale(1); opacity: 1; } }
        @keyframes slideInText { to { opacity: 1; transform: translateX(0); } }
        @keyframes glowBlue { 0% { filter: drop-shadow(0 0 5px #00d2ff); } 100% { filter: drop-shadow(0 0 20px #00d2ff); } }

        /* --- SETTINGS --- */
        .settings-panel {
            position: fixed; top: 25px; right: 25px; z-index: 10001;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.2);
            pointer-events: auto;
        }

        #ui_overlay {
            position: absolute; bottom: 20px; right: 20px;
            width: 240px; height: 180px; border: 1px solid #00d2ff;
            background: rgba(0, 210, 255, 0.1); border-radius: 10px; transform: scaleX(-1);
        }
        #input_video { display: none; }
    </style>
</head>
<body>

    <div id="glass-cursor"></div>

    <div class="profile-container" onclick="window.location.href='dashboard.html'">
        <img id="p-img" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="profile-img">
        <span id="p-name" class="profile-name">USER</span>
    </div>

    <div class="settings-panel">
        <label>Atom: <span id="count-val">10000</span></label><br>
        <input type="range" id="particle-count" min="1000" max="50000" step="1000" value="10000">
    </div>

    <div id="intro-screen">
        <div class="intro-content">
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/98/Microsoft_Edge_logo_%282019%29.svg" alt="Logo" id="edge-logo">
            <h1 id="intro-text">Homidjon Coding...</h1>
        </div>
    </div>

    <video id="input_video" playsinline muted></video>
    <canvas id="ui_overlay"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1632432244/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- 1. GLOBAL O'ZGARUVCHILAR (ENG TEPADA) ---
        let count = 10000;
        let scene, camera, renderer, particles, geometry;
        let middleFingerTimer = null;
        let isMiddleFingerSequence = false;
        let middleFingerStage = 'NONE';
        let isModeActive = false; // Quyosh/Galaktika rejimi uchun

        // Hand Rotation Uchun
        let targetRotationX = 0;
        let targetRotationY = 0;
        let targetRotationZ = 0;

        // Ma'lumotlar saqlash
        const shapes = { scatter: [], sphere: [], heart: [], torus: [], middleFinger: [], solarSystem: [], galaxy: [], text: [] };
        const colors = { default: [], solar: [], galaxy: [], middle: [] };

        const videoElement = document.getElementById('input_video');
        const uiCanvas = document.getElementById('ui_overlay');
        const uiCtx = uiCanvas.getContext('2d');
        const slider = document.getElementById('particle-count');
        const countDisplay = document.getElementById('count-val');

        // --- 2. INTRO LOGIC ---
        setTimeout(() => {
            const intro = document.getElementById('intro-screen');
            intro.style.opacity = '0';
            setTimeout(() => intro.remove(), 1000);
        }, 5000);

        // --- 3. PROFIL YUKLASH ---
        try {
            const user = JSON.parse(localStorage.getItem('atom_user'));
            if(user) {
                document.getElementById('p-name').innerText = user.nickname || user.name;
                if(user.picture) document.getElementById('p-img').src = user.picture;
            }
        } catch(e) {}

        // --- 4. KURSOR ---
        const cursor = document.getElementById('glass-cursor');
        document.addEventListener('mousemove', e => {
            cursor.style.left = e.clientX + 'px'; cursor.style.top = e.clientY + 'px';
        });
        document.querySelectorAll('.profile-container, input').forEach(el => {
            el.addEventListener('mouseenter', () => cursor.classList.add('hovered'));
            el.addEventListener('mouseleave', () => cursor.classList.remove('hovered'));
        });
        document.addEventListener('mousedown', () => cursor.classList.add('clicked'));
        document.addEventListener('mouseup', () => cursor.classList.remove('clicked'));

        // --- 5. GENERATOR (SHAKLLAR VA RANGLAR) ---
        function createPointsData(newCount) {
            // Tozalash
            for(let k in shapes) shapes[k] = [];
            for(let k in colors) colors[k] = [];

            for (let i = 0; i < newCount; i++) {
                // DEFAULT (Blue)
                colors.default.push(0, 0.8, 1);

                // SCATTER
                shapes.scatter.push((Math.random()-0.5)*30, (Math.random()-0.5)*30, (Math.random()-0.5)*30);

                // SPHERE
                const phi = Math.acos(-1 + (2 * i) / newCount);
                const theta = Math.sqrt(newCount * Math.PI) * phi;
                shapes.sphere.push(4 * Math.cos(theta) * Math.sin(phi), 4 * Math.sin(theta) * Math.sin(phi), 4 * Math.cos(phi));

                // SOLAR SYSTEM (4 Barmoq)
                let sx, sy, sz, sr, sg, sb;
                if (i < newCount * 0.15) { // QUYOSH
                    const sPhi = Math.acos(-1 + (2 * i) / (newCount * 0.15));
                    const sTheta = Math.sqrt((newCount * 0.15) * Math.PI) * sPhi;
                    sx = 2 * Math.cos(sTheta) * Math.sin(sPhi);
                    sy = 2 * Math.sin(sTheta) * Math.sin(sPhi);
                    sz = 2 * Math.cos(sPhi);
                    sr=1; sg=0.8; sb=0; // Sariq
                } else if (i < newCount * 0.25) { // YER
                    const ang = Math.random() * Math.PI * 2;
                    sx = 6 * Math.cos(ang) + (Math.random()-0.5);
                    sz = 6 * Math.sin(ang) + (Math.random()-0.5);
                    sy = (Math.random()-0.5);
                    sr=0; sg=0.4; sb=1; // Moviy
                } else { // YULDUZLAR
                    const dist = 4 + Math.random() * 12;
                    const ang = Math.random() * Math.PI * 2;
                    sx = dist * Math.cos(ang);
                    sz = dist * Math.sin(ang);
                    sy = (Math.random()-0.5)*0.5;
                    sr=0.7; sg=0.7; sb=0.7;
                }
                shapes.solarSystem.push(sx, sy, sz);
                colors.solar.push(sr, sg, sb);

                // GALAXY (5 Barmoq)
                const arm = i % 3;
                const r = Math.random() * 15;
                const spin = r * 0.8 + (arm * (Math.PI * 2 / 3));
                const spread = (Math.random()-0.5)*2;
                shapes.galaxy.push(
                    (r * Math.cos(spin)) + spread,
                    (Math.random()-0.5) * (15-r) * 0.2,
                    (r * Math.sin(spin)) + spread
                );
                // Markaz oq, chetlar binafsha
                if(r < 3) colors.galaxy.push(1, 0.9, 0.7);
                else colors.galaxy.push(0.5, 0, 1);

                // MIDDLE FINGER (Qo'l shakli)
                let mx, my, mz;
                if (i < newCount * 0.4) { // Kaft
                    mx = (Math.random()-0.5)*4; my = (Math.random()-0.5)*4; mz = (Math.random()-0.5);
                } else if (i < newCount * 0.6) { // O'rta barmoq
                    mx = (Math.random()-0.5); my = 2 + Math.random()*5; mz = (Math.random()-0.5);
                } else { // Bukilganlar
                    const f = Math.floor(Math.random()*4); // 0,1,2,3
                    mx = ((f-1.5)*1.5) + (Math.random()-0.5);
                    my = -1 + (Math.random()-0.5);
                    mz = 1.5 + (Math.random()-0.5);
                }
                shapes.middleFinger.push(mx, my, mz);
                colors.middle.push(1, 0.1, 0.1); // Qizil

                // TEXT
                shapes.text.push(0,0,0);
            }
        }

        function generateTextParticles(text) {
            const c = document.createElement('canvas');
            const ctx = c.getContext('2d');
            c.width = 500; c.height = 200;
            ctx.fillStyle = '#000'; ctx.fillRect(0,0,500,200);
            ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.font = 'bold 80px Arial';
            ctx.fillText(text, 250, 100);
            
            const data = ctx.getImageData(0,0,500,200).data;
            const pixels = [];
            for(let y=0; y<200; y+=4) {
                for(let x=0; x<500; x+=4) {
                    if(data[(y*500+x)*4] > 128) pixels.push({x:(x-250)*0.06, y:-(y-100)*0.06});
                }
            }
            
            for(let i=0; i<count; i++) {
                const p = pixels[i%pixels.length];
                if(p) {
                    shapes.text[i*3] = p.x; shapes.text[i*3+1] = p.y; shapes.text[i*3+2] = 0;
                } else {
                    shapes.text[i*3] = (Math.random()-0.5)*60; 
                    shapes.text[i*3+1] = (Math.random()-0.5)*60; 
                    shapes.text[i*3+2] = (Math.random()-0.5)*60;
                }
            }
        }

        // --- 6. THREE.JS INIT ---
        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.z = 16;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            createPointsData(count);

            geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(shapes.scatter, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors.default, 3));

            const mat = new THREE.PointsMaterial({
                size: 0.08, vertexColors: true, transparent: true,
                blending: THREE.AdditiveBlending, depthWrite: false
            });

            particles = new THREE.Points(geometry, mat);
            scene.add(particles);
        }

        // --- 7. LOGIKA (HANDS) ---
        function handleLogic(hands) {
            const posAttr = geometry.attributes.position;
            const colAttr = geometry.attributes.color;
            let target = shapes.sphere;
            let targetCol = colors.default;
            
            // Default aylanish (agar qo'l bo'lmasa)
            let rotX = 0, rotZ = 0;

            if (hands.length > 0) {
                const h = hands[0];

                // --- ROTATION SYNC ---
                // Qo'lning burchagini hisoblash
                const dx = h[9].x - h[0].x;
                const dy = h[9].y - h[0].y;
                targetRotationZ = -Math.atan2(dx, dy) + Math.PI; // Z o'qi bo'yicha
                targetRotationX = (h[9].z) * 2; // X o'qi (oldin-orqa)

                // --- BARMOQ SANASH ---
                const tips = [8, 12, 16, 20];
                const pips = [6, 10, 14, 18];
                let fingers = 0;
                let states = [false, false, false, false]; // Index, Middle, Ring, Pinky

                // Bosh barmoq (taxminiy)
                if(h[4].x < h[3].x) fingers++; 

                for(let i=0; i<4; i++) {
                    if(h[tips[i]].y < h[pips[i]].y) { // Tik turibdi
                        fingers++;
                        states[i] = true;
                    }
                }

                // --- O'RTA BARMOQ (Index=0, Middle=1, Ring=2, Pinky=3) ---
                const isMiddle = (!states[0] && states[1] && !states[2] && !states[3]);

                if (isMiddleFingerSequence) {
                    // Animatsiya ketmoqda...
                }
                else if (isMiddle) {
                    // START SEQUENCE
                    isMiddleFingerSequence = true;
                    generateTextParticles("FUCK YOU BITCH");
                    middleFingerStage = 'TEXT';
                    
                    setTimeout(() => { middleFingerStage = 'HAND'; }, 3000);
                    setTimeout(() => { isMiddleFingerSequence = false; middleFingerStage = 'NONE'; }, 6000);
                }
                else if (fingers === 4) {
                    target = shapes.solarSystem;
                    targetCol = colors.solar;
                    isModeActive = true;
                }
                else if (fingers === 5) {
                    target = shapes.galaxy;
                    targetCol = colors.galaxy;
                    isModeActive = true;
                }
                else {
                    isModeActive = false;
                    // Agar 2 qo'l bo'lsa
                    if (hands.length === 2) {
                        const d = Math.hypot(hands[0][9].x - hands[1][9].x, hands[0][9].y - hands[1][9].y);
                        particles.scale.setScalar(d * 10);
                    } else {
                        particles.scale.setScalar(1);
                    }
                }
            } else {
                target = shapes.scatter;
                // Qo'l yo'q bo'lsa sekin aylanadi
                particles.rotation.y += 0.002;
            }

            // --- ANIMATSIYA BOSQICHLARI ---
            if (isMiddleFingerSequence) {
                targetCol = colors.middle;
                if (middleFingerStage === 'TEXT') target = shapes.text;
                else if (middleFingerStage === 'HAND') target = shapes.middleFinger;
            }

            // --- LERP (SILJISH) ---
            for(let i=0; i<count; i++) {
                posAttr.array[i*3] += (target[i*3] - posAttr.array[i*3]) * 0.12;
                posAttr.array[i*3+1] += (target[i*3+1] - posAttr.array[i*3+1]) * 0.12;
                posAttr.array[i*3+2] += (target[i*3+2] - posAttr.array[i*3+2]) * 0.12;
                
                colAttr.array[i*3] += (targetCol[i*3] - colAttr.array[i*3]) * 0.08;
                colAttr.array[i*3+1] += (targetCol[i*3+1] - colAttr.array[i*3+1]) * 0.08;
                colAttr.array[i*3+2] += (targetCol[i*3+2] - colAttr.array[i*3+2]) * 0.08;
            }

            // --- ROTATION SYNC ---
            if (hands.length > 0 && !isMiddleFingerSequence) {
                // Qo'l bilan sinxronlash
                particles.rotation.x += (targetRotationX - particles.rotation.x) * 0.1;
                particles.rotation.z += (targetRotationZ - particles.rotation.z) * 0.1;
            } 
            // Maxsus rejimda (Quyosh/Galaktika) o'zi ham aylansin
            if (isModeActive) {
                particles.rotation.y += 0.005; 
            }

            posAttr.needsUpdate = true;
            colAttr.needsUpdate = true;
        }

        // --- 8. MEDIAPIPE INIT (CDN TUZATILDI) ---
        const handsTracker = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}`
        });
        handsTracker.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5 });
        handsTracker.onResults(results => {
            uiCtx.clearRect(0, 0, uiCanvas.width, uiCanvas.height);
            if(results.multiHandLandmarks) {
                for(const l of results.multiHandLandmarks) drawConnectors(uiCtx, l, HAND_CONNECTIONS, {color: '#00d2ff'});
                handleLogic(results.multiHandLandmarks);
            }
        });

        const cam = new Camera(videoElement, {
            onFrame: async () => { 
                if(videoElement.videoWidth) await handsTracker.send({image: videoElement}); 
            },
            width: 640, height: 480
        });
        cam.start();

        initThree();
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        slider.oninput = function() {
            count = parseInt(this.value);
            countDisplay.textContent = count;
            createPointsData(count);
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(shapes.scatter, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors.default, 3));
        };
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
