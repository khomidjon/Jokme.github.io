<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis - Atom Fixed</title>
    <style>
        /* --- ASOSIY STYLE --- */
        * { cursor: none !important; margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: #fff; }

        /* --- GLASS KURSOR --- */
        #glass-cursor {
            position: fixed; top: 0; left: 0; width: 30px; height: 30px; border-radius: 50%;
            background: rgba(0, 210, 255, 0.15); backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 210, 255, 0.5); box-shadow: 0 0 15px rgba(0, 210, 255, 0.4);
            pointer-events: none; z-index: 99999; transform: translate(-50%, -50%);
            transition: width 0.1s, height 0.1s;
        }
        #glass-cursor.hovered { width: 50px; height: 50px; background: rgba(0, 210, 255, 0.3); box-shadow: 0 0 30px #00d2ff; }
        #glass-cursor.clicked { transform: translate(-50%, -50%) scale(0.8); background: rgba(0, 210, 255, 0.8); }

        /* --- PROFIL --- */
        .profile-container {
            position: fixed; top: 30px; left: 30px; z-index: 10001;
            display: flex; align-items: center; gap: 15px;
            background: rgba(20, 30, 50, 0.6); backdrop-filter: blur(10px);
            padding: 10px 20px; border-radius: 50px; border: 1px solid rgba(0, 210, 255, 0.3);
            transition: 0.3s; pointer-events: auto;
        }
        .profile-container:hover { transform: scale(1.05); border-color: #00d2ff; }
        .profile-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #00d2ff; }
        .profile-name { font-weight: 800; font-size: 16px; color: #fff; text-transform: uppercase; }
        .profile-status { font-size: 11px; color: #00d2ff; font-weight: bold; margin-left: 5px; }

        /* --- UI PANEL --- */
        .settings-panel {
            position: fixed; top: 30px; right: 30px; z-index: 10001;
            background: rgba(20, 30, 50, 0.6); backdrop-filter: blur(10px);
            padding: 15px 25px; border-radius: 20px; border: 1px solid rgba(0, 210, 255, 0.3);
            text-align: right; pointer-events: auto;
        }
        .settings-panel label { color: #00d2ff; font-weight: bold; font-size: 12px; }
        input[type=range] { width: 120px; accent-color: #00d2ff; }

        /* --- MONITOR --- */
        #ui_overlay {
            position: absolute; bottom: 30px; right: 30px; width: 240px; height: 180px;
            border: 2px solid #00d2ff; background: rgba(0, 20, 40, 0.5); border-radius: 15px;
            transform: scaleX(-1); box-shadow: 0 0 20px rgba(0, 210, 255, 0.2);
        }
        #input_video { display: none; }

        /* --- STATUS TEXT --- */
        #mode-status {
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%);
            color: #00d2ff; font-size: 20px; font-weight: 900;
            text-shadow: 0 0 15px #00d2ff; letter-spacing: 3px; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="glass-cursor"></div>

    <div class="profile-container" onclick="window.location.href='dashboard.html'">
        <img id="p-img" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="profile-img">
        <div style="display:flex; flex-direction:column;">
            <span id="p-name" class="profile-name">USER</span>
            <span class="profile-status">ONLINE â€¢ JARVIS</span>
        </div>
    </div>

    <div class="settings-panel">
        <label>ZARRALAR: <span id="count-val">15000</span></label><br>
        <input type="range" id="particle-count" min="1000" max="50000" step="1000" value="15000">
    </div>

    <div id="mode-status">TIZIM TAYYOR</div>

    <video id="input_video" playsinline muted></video>
    <canvas id="ui_overlay"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1632432244/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js"></script>

    <script>
        // --- 1. GLOBAL SOZLAMALAR ---
        let count = 15000;
        let scene, camera, renderer, particles, geometry;
        
        // Animatsiya holatlari
        let isMiddleFingerSequence = false;
        let middleFingerStage = 'NONE';
        let isModeActive = false;
        
        // Qo'l Rotatsiyasi
        let handRotX = 0, handRotY = 0, handRotZ = 0;

        // Ma'lumotlar ombori
        const shapes = { scatter: [], sphere: [], solarSystem: [], galaxy: [], middleFinger3D: [], textMessage: [] };
        const colors = { default: [], solar: [], galaxy: [], danger: [] };

        // Elementlar
        const videoElement = document.getElementById('input_video');
        const uiCanvas = document.getElementById('ui_overlay');
        const uiCtx = uiCanvas.getContext('2d');
        const statusText = document.getElementById('mode-status');

        // --- 2. PROFILNI YUKLASH ---
        try {
            const user = JSON.parse(localStorage.getItem('atom_user'));
            if(user) {
                document.getElementById('p-name').innerText = user.nickname || user.name;
                if(user.picture) document.getElementById('p-img').src = user.picture;
            }
        } catch(e) {}

        // --- 3. KURSOR MANTIQI ---
        const cursor = document.getElementById('glass-cursor');
        document.addEventListener('mousemove', e => {
            cursor.style.left = e.clientX + 'px'; cursor.style.top = e.clientY + 'px';
        });
        document.addEventListener('mousedown', () => cursor.classList.add('clicked'));
        document.addEventListener('mouseup', () => cursor.classList.remove('clicked'));
        document.querySelectorAll('.profile-container, input').forEach(el => {
            el.addEventListener('mouseenter', () => cursor.classList.add('hovered'));
            el.addEventListener('mouseleave', () => cursor.classList.remove('hovered'));
        });

        // --- 4. ZARRALARNI HISOBLASH (ENGINE) ---
        function createParticleData(cnt) {
            for(let key in shapes) shapes[key] = [];
            for(let key in colors) colors[key] = [];

            for (let i = 0; i < cnt; i++) {
                // DEFAULT RANG (Neon Blue)
                colors.default.push(0, 0.8, 1);
                colors.danger.push(1, 0, 0);

                // 1. SCATTER (Boshlang'ich holat)
                shapes.scatter.push((Math.random()-0.5)*40, (Math.random()-0.5)*40, (Math.random()-0.5)*40);

                // 2. SPHERE (Shar)
                const phi = Math.acos(-1 + (2 * i) / cnt);
                const theta = Math.sqrt(cnt * Math.PI) * phi;
                shapes.sphere.push(4.5 * Math.cos(theta) * Math.sin(phi), 4.5 * Math.sin(theta) * Math.sin(phi), 4.5 * Math.cos(phi));

                // 3. SOLAR SYSTEM (4 Barmoq)
                let sx, sy, sz, sr, sg, sb;
                if (i < cnt * 0.15) { // QUYOSH
                    const sPhi = Math.acos(-1 + (2 * i) / (cnt * 0.15));
                    const sTheta = Math.sqrt((cnt * 0.15) * Math.PI) * sPhi;
                    sx = 2 * Math.cos(sTheta) * Math.sin(sPhi); sy = 2 * Math.sin(sTheta) * Math.sin(sPhi); sz = 2 * Math.cos(sPhi);
                    sr=1; sg=0.9; sb=0;
                } else if (i < cnt * 0.30) { // YER
                    const eIdx = i - (cnt * 0.15);
                    const eCount = cnt * 0.15;
                    const ePhi = Math.acos(-1 + (2 * eIdx) / eCount);
                    const eTheta = Math.sqrt(eCount * Math.PI) * ePhi;
                    sx = 0.8 * Math.cos(eTheta) * Math.sin(ePhi) + 6; 
                    sy = 0.8 * Math.sin(eTheta) * Math.sin(ePhi); 
                    sz = 0.8 * Math.cos(ePhi);
                    sr=0; sg=0.5; sb=1;
                } else { // YULDUZLAR
                    const dist = 10 + Math.random() * 10;
                    const ang = Math.random() * Math.PI * 2;
                    sx = dist * Math.cos(ang); sz = dist * Math.sin(ang); sy = (Math.random()-0.5)*0.5;
                    sr=0.8; sg=0.8; sb=0.8;
                }
                shapes.solarSystem.push(sx, sy, sz); colors.solar.push(sr, sg, sb);

                // 4. GALAXY (5 Barmoq)
                const arm = i % 3;
                const r = Math.random() * 15;
                const spin = r * 0.8 + (arm * (Math.PI * 2 / 3));
                const spread = (Math.random()-0.5)*2;
                const gx = (r * Math.cos(spin)) + spread;
                const gz = (r * Math.sin(spin)) + spread;
                shapes.galaxy.push(gx, (Math.random()-0.5)*(15-r)*0.2, gz);
                
                if(r<3) colors.galaxy.push(1, 0.9, 0.7);
                else colors.galaxy.push(0.4, 0, 1);

                // 5. MIDDLE FINGER (3D)
                let mx, my, mz;
                if (i < cnt * 0.4) { // Kaft
                    mx = (Math.random()-0.5)*3.5; my = (Math.random()-0.5)*3.5 - 1; mz = (Math.random()-0.5);
                } else if (i < cnt * 0.7) { // O'rta barmoq
                    const h = Math.random() * 5; const rad = 0.6; const ang = Math.random()*Math.PI*2;
                    mx = rad * Math.cos(ang); my = h + 1; mz = rad * Math.sin(ang);
                } else { // Bukilganlar
                    const f = Math.floor(Math.random()*4); 
                    let xo = 0; if(f==0) xo=-1.8; if(f==1) xo=-0.8; if(f==2) xo=1.0; if(f==3) xo=2.0;
                    mx = xo + (Math.random()-0.5)*0.6; my = (Math.random()-0.5); mz = 1.2 + (Math.random()-0.5);
                }
                shapes.middleFinger3D.push(mx, my, mz);
                shapes.textMessage.push(0,0,0);
            }
        }

        function generateTextPositions(text) {
            const tCanvas = document.createElement('canvas');
            const tCtx = tCanvas.getContext('2d');
            tCanvas.width = 600; tCanvas.height = 200;
            tCtx.fillStyle = '#000'; tCtx.fillRect(0,0,600,200);
            tCtx.fillStyle = '#fff'; tCtx.font = 'bold 80px Arial';
            tCtx.textAlign = 'center'; tCtx.textBaseline = 'middle';
            tCtx.fillText(text, 300, 100);
            
            const data = tCtx.getImageData(0,0,600,200).data;
            const pixels = [];
            for(let y=0; y<200; y+=4) {
                for(let x=0; x<600; x+=4) {
                    if(data[(y*600+x)*4] > 128) pixels.push({x:(x-300)*0.05, y:-(y-100)*0.05});
                }
            }
            
            for(let i=0; i<count; i++) {
                const p = pixels[i%pixels.length];
                if(p) { shapes.textMessage[i*3] = p.x; shapes.textMessage[i*3+1] = p.y; shapes.textMessage[i*3+2] = 0; }
                else { shapes.textMessage[i*3] = (Math.random()-0.5)*60; shapes.textMessage[i*3+1] = (Math.random()-0.5)*60; shapes.textMessage[i*3+2] = -50; }
            }
        }

        // --- 5. GRAFIKANI ISHGA TUSHIRISH (CAMERA KUTMASDAN!) ---
        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 16;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            createParticleData(count);

            geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(shapes.scatter, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors.default, 3));

            const mat = new THREE.PointsMaterial({ size: 0.09, vertexColors: true, transparent: true, blending: THREE.AdditiveBlending, depthWrite: false });
            particles = new THREE.Points(geometry, mat);
            scene.add(particles);
            
            animate(); // Animatsiyani boshlash
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        // Dastlabki ishga tushirish (Kameradan oldin!)
        initThree();

        // --- 6. KAMERA VA LOGIKA ---
        function startCamera() {
            try {
                const handsTracker = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}`});
                handsTracker.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });
                
                handsTracker.onResults(results => {
                    uiCtx.clearRect(0, 0, uiCanvas.width, uiCanvas.height);
                    if(results.multiHandLandmarks) {
                        for(const l of results.multiHandLandmarks) drawConnectors(uiCtx, l, HAND_CONNECTIONS, {color: '#00d2ff'});
                        handleHandLogic(results.multiHandLandmarks);
                    } else {
                        handleHandLogic([]);
                    }
                });

                const cam = new Camera(videoElement, {
                    onFrame: async () => { await handsTracker.send({image: videoElement}); },
                    width: 640, height: 480
                });
                cam.start();
            } catch (err) {
                console.log("Kamera xatosi:", err);
                statusText.innerText = "KAMERA TOPILMADI (ZARRALAR FAOL)";
            }
        }

        // Kamerani sal kechroq yoqamiz (Grafika qotib qolmasligi uchun)
        setTimeout(startCamera, 1000);

        // --- 7. MANTIQ (HAND LOGIC) ---
        function handleHandLogic(hands) {
            const posAttr = geometry.attributes.position;
            const colAttr = geometry.attributes.color;
            let target = shapes.sphere;
            let targetCol = colors.default;

            if (hands.length > 0) {
                const h = hands[0];
                const dx = h[9].x - h[0].x; const dy = h[9].y - h[0].y;
                handRotZ = -Math.atan2(dx, dy) + Math.PI;
                handRotX = (h[9].z) * 3; 
                handRotY = (h[9].x - 0.5) * 2;

                // Barmoq sanash
                let fingers = 0;
                if (h[4].x < h[3].x) fingers++;
                const tips=[8,12,16,20], pips=[6,10,14,18];
                let states = [false, false, false, false];
                for(let i=0; i<4; i++) {
                    if (h[tips[i]].y < h[pips[i]].y) { fingers++; states[i] = true; }
                }

                // Middle Finger Logic
                if (!states[0] && states[1] && !states[2] && !states[3]) {
                    if(!isMiddleFingerSequence) startFuckSequence();
                } else if (fingers === 4) {
                    target = shapes.solarSystem; targetCol = colors.solar;
                    isModeActive = true; statusText.innerText = "QUYOSH TIZIMI";
                } else if (fingers === 5) {
                    target = shapes.galaxy; targetCol = colors.galaxy;
                    isModeActive = true; statusText.innerText = "GALAKTIKA";
                } else {
                    isModeActive = false; statusText.innerText = "TIZIM FAOL";
                    if(hands.length === 2) {
                        const d = Math.hypot(hands[0][9].x - hands[1][9].x, hands[0][9].y - hands[1][9].y);
                        particles.scale.setScalar(d * 8);
                    } else particles.scale.setScalar(1);
                }
            } else {
                target = shapes.scatter;
                particles.rotation.y += 0.001;
                statusText.innerText = "QO'L KUTILMOQDA...";
            }

            // Animatsiya Override
            if (isMiddleFingerSequence) {
                targetCol = colors.danger;
                if (middleFingerStage === 'TEXT') { target = shapes.textMessage; statusText.innerText = "XABAR..."; }
                else { 
                    target = shapes.middleFinger3D; 
                    particles.rotation.z = Math.sin(Date.now()*0.02)*0.3; // Silkinish
                    statusText.innerText = "FUCK YOU!";
                }
            }

            // Lerp
            for(let i=0; i<count; i++) {
                posAttr.array[i*3] += (target[i*3] - posAttr.array[i*3]) * 0.12;
                posAttr.array[i*3+1] += (target[i*3+1] - posAttr.array[i*3+1]) * 0.12;
                posAttr.array[i*3+2] += (target[i*3+2] - posAttr.array[i*3+2]) * 0.12;
                
                colAttr.array[i*3] += (targetCol[i*3] - colAttr.array[i*3]) * 0.08;
                colAttr.array[i*3+1] += (targetCol[i*3+1] - colAttr.array[i*3+1]) * 0.08;
                colAttr.array[i*3+2] += (targetCol[i*3+2] - colAttr.array[i*3+2]) * 0.08;
            }

            // Rotatsiya
            if (hands.length > 0 && !isMiddleFingerSequence) {
                if(isModeActive) particles.rotation.y += 0.005;
                particles.rotation.x += (handRotX - particles.rotation.x) * 0.1;
                particles.rotation.z += (handRotZ - particles.rotation.z) * 0.1;
            }

            posAttr.needsUpdate = true; colAttr.needsUpdate = true;
        }

        function startFuckSequence() {
            isMiddleFingerSequence = true;
            generateTextPositions("FUCK YOU BITCH");
            middleFingerStage = 'TEXT';
            setTimeout(() => { middleFingerStage = 'HAND'; }, 3000);
            setTimeout(() => { isMiddleFingerSequence = false; particles.rotation.set(0,0,0); }, 6000);
        }

        // Slider
        document.getElementById('particle-count').oninput = function() {
            count = parseInt(this.value);
            document.getElementById('count-val').innerText = count;
            createParticleData(count);
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(shapes.scatter, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors.default, 3));
        };

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
