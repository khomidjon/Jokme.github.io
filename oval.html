<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>JOKKER</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; }
        /* Kanvasni oynadek o'girish va to'liq 100% ekran qilish */
        canvas { 
            display: block; 
            transform: scaleX(-1); 
            width: 100vw; 
            height: 100vh; 
            object-fit: cover; /* Ekranni to'ldirish uchun */
        }
        video { display: none; }
    </style>
</head>
<body>

<video id="input_video"></video>
<canvas id="output_canvas"></canvas>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');

    // Ekranni to'liq egallash funksiyasi
    function resizeCanvas() {
        canvasElement.width = window.innerWidth;
        canvasElement.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    let balls = [];
    let gridMap = {}; 

    // --- SOZLAMALAR ---
    const GRID_SIZE = 35; // Kichraytirdim (Zichroq bo'lishi uchun)
    const PINCH_THRESHOLD = 0.05; 
    const FIST_THRESHOLD = 0.25;  

    // JOKKER Ranglar
    function getJokkerColor() {
        const palette = [
            '#FFFFFF', '#FFFFFF', '#FFFFFF', '#FFFFFF', '#FFFFFF', // OQ
            '#FF0000', // Qizil
            '#00FFFF'  // Havorang
        ];
        return palette[Math.floor(Math.random() * palette.length)];
    }

    const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }});

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
    });

    hands.onResults(onResults);

    // KAMERANI ENG KATTA FORMATDA OCHISH (PC uchun)
    const camera = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 1920, // Full HD so'rovi
        height: 1080
    });
    camera.start();

    function onResults(results) {
        // 1. Fon qora
        canvasCtx.fillStyle = '#000000';
        canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);

        // 2. Sharlarni chizish
        drawAnimatedBalls();

        // 3. Qo'l logikasi
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            
            // Skelet
            drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 1});
            drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1, radius: 2});

            const indexTip = landmarks[8];
            const thumbTip = landmarks[4];
            
            // Normallashtirilgan koordinatalarni ekran o'lchamiga ko'paytiramiz
            const x = indexTip.x * canvasElement.width;
            const y = indexTip.y * canvasElement.height;

            // --- MUSHT (RESET) ---
            const wrist = landmarks[0];
            const middleTip = landmarks[12];
            const distMiddle = Math.hypot(middleTip.x - wrist.x, middleTip.y - wrist.y);
            
            if (distMiddle < FIST_THRESHOLD) {
                balls = [];     
                gridMap = {};   
                return; 
            } 
            
            // --- PINCH (CHIZISH) ---
            const pinchDist = Math.hypot(indexTip.x - thumbTip.x, indexTip.y - thumbTip.y);

            if (pinchDist < PINCH_THRESHOLD) {
                // Oq Kursor
                canvasCtx.beginPath();
                canvasCtx.arc(x, y, 5, 0, 2 * Math.PI);
                canvasCtx.fillStyle = '#FFFFFF';
                canvasCtx.fill();

                // GRID TIZIMI (Zich)
                const col = Math.floor(x / GRID_SIZE);
                const row = Math.floor(y / GRID_SIZE);
                const key = `${col},${row}`;

                if (!gridMap[key]) {
                    // Markazlashtirish
                    const centerX = col * GRID_SIZE + (GRID_SIZE / 2);
                    const centerY = row * GRID_SIZE + (GRID_SIZE / 2);

                    addBall(centerX, centerY, key);
                }
            }
        }
    }

    function addBall(x, y, key) {
        balls.push({
            x: x,
            y: y,
            key: key,
            color: getJokkerColor(),
            timeOffset: Date.now()
        });
        gridMap[key] = true;

        // Xotira (Zich bo'lgani uchun ko'proq shar sig'diramiz)
        if (balls.length > 600) {
            const removedBall = balls.shift();
            if (removedBall) delete gridMap[removedBall.key];
        }
    }

    function drawAnimatedBalls() {
        const time = Date.now() * 0.003;
        
        // Sharning radiusi katak o'lchamiga moslashadi (bir-biriga tegmaydi)
        const baseRadius = (GRID_SIZE / 2) - 2; 

        balls.forEach(ball => {
            // Animatsiya
            const scale = 1 + Math.sin(time + ball.x * 0.05 + ball.y * 0.05) * 0.15;
            const radius = baseRadius * scale; 

            canvasCtx.beginPath();
            const gradient = canvasCtx.createRadialGradient(
                ball.x, ball.y, radius * 0.1, 
                ball.x, ball.y, radius
            );
            gradient.addColorStop(0, '#FFFFFF');
            gradient.addColorStop(0.5, ball.color);
            gradient.addColorStop(1, 'rgba(0,0,0,0)');

            canvasCtx.fillStyle = gradient;
            canvasCtx.arc(ball.x, ball.y, radius, 0, Math.PI * 2);
            canvasCtx.fill();
        });
    }

    window.addEventListener('resize', () => {
        resizeCanvas();
        balls = [];
        gridMap = {};
    });

</script>

</body>
</html>
