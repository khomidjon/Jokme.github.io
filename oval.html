<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>JOKKER: Matrix Grid Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; }
        canvas { display: block; transform: scaleX(-1); width: 100vw; height: 100vh; }
        video { display: none; }
    </style>
</head>
<body>

<video id="input_video"></video>
<canvas id="output_canvas"></canvas>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');

    // Ekranni to'liq egallash
    canvasElement.width = window.innerWidth;
    canvasElement.height = window.innerHeight;

    let balls = [];
    let gridMap = {}; // Qaysi katak band ekanligini bilish uchun xarita

    // --- SOZLAMALAR ---
    const GRID_SIZE = 60; // Katak o'lchami (Kattaroq qildim, aniq ko'rinishi uchun)
    const PINCH_THRESHOLD = 0.05; // Pinch sezgirligi
    const FIST_THRESHOLD = 0.25;  // Musht sezgirligi (Oldin 0.15 edi, kuchaytirildi)

    // JOKKER Ranglar
    function getJokkerColor() {
        const palette = [
            '#FFFFFF', '#FFFFFF', '#FFFFFF', '#FFFFFF', '#FFFFFF', '#FFFFFF', // OQ (Ko'p)
            '#FF0000', // Qizil
            '#00FFFF'  // Havorang
        ];
        return palette[Math.floor(Math.random() * palette.length)];
    }

    const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }});

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
    });

    hands.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 1280, height: 720
    });
    camera.start();

    function onResults(results) {
        // 1. Fon qora
        canvasCtx.fillStyle = '#000000';
        canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);

        // 2. Sharlarni chizish
        drawAnimatedBalls();

        // 3. Qo'l logikasi
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            
            // Skeletni chizish (Yashil)
            drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
            drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1, radius: 3});

            // Koordinatalar
            const indexTip = landmarks[8];
            const thumbTip = landmarks[4];
            const x = indexTip.x * canvasElement.width;
            const y = indexTip.y * canvasElement.height;

            // --- MUSHT (RESET) - KUCHAYTIRILGAN ---
            const wrist = landmarks[0];
            const middleTip = landmarks[12]; // O'rta barmoq
            const ringTip = landmarks[16];   // Nomsiz barmoq
            
            // O'rta barmoq bilakka yaqinlashsa YOKI Nomsiz barmoq yaqinlashsa
            const distMiddle = Math.hypot(middleTip.x - wrist.x, middleTip.y - wrist.y);
            
            if (distMiddle < FIST_THRESHOLD) {
                balls = [];     // Sharlarni o'chirish
                gridMap = {};   // Xaritani tozalash (Kataklarni bo'shatish)
                return; 
            } 
            
            // --- PINCH (CHIZISH) - GRID TIZIMI ---
            const pinchDist = Math.hypot(indexTip.x - thumbTip.x, indexTip.y - thumbTip.y);

            if (pinchDist < PINCH_THRESHOLD) {
                // Kursor
                canvasCtx.beginPath();
                canvasCtx.arc(x, y, 8, 0, 2 * Math.PI);
                canvasCtx.fillStyle = '#FFFFFF';
                canvasCtx.fill();

                // 1. Koordinatani GRID (Katak) ga aylantiramiz
                // Masalan: x=125, GRID=60 bo'lsa -> Col = 2
                const col = Math.floor(x / GRID_SIZE);
                const row = Math.floor(y / GRID_SIZE);
                
                // 2. Katak kaliti (ID)
                const key = `${col},${row}`;

                // 3. Agar bu katak bo'sh bo'lsa -> Shar qo'shamiz
                if (!gridMap[key]) {
                    // Sharni KATAK O'RTASIGA joylaymiz (Snap to center)
                    const centerX = col * GRID_SIZE + (GRID_SIZE / 2);
                    const centerY = row * GRID_SIZE + (GRID_SIZE / 2);

                    addBall(centerX, centerY, key);
                }
            }
        }
    }

    function addBall(x, y, key) {
        balls.push({
            x: x,
            y: y,
            key: key, // Katak ID sini saqlab qo'yamiz
            color: getJokkerColor(),
            timeOffset: Date.now()
        });
        
        // Katakni band qilamiz
        gridMap[key] = true;

        // Xotira nazorati (Eski sharlarni o'chirish)
        if (balls.length > 300) {
            const removedBall = balls.shift();
            // O'chgan sharning katagini bo'shatamiz
            if (removedBall) delete gridMap[removedBall.key];
        }
    }

    function drawAnimatedBalls() {
        const time = Date.now() * 0.003;
        balls.forEach(ball => {
            // Animatsiya
            const scale = 1 + Math.sin(time + ball.x * 0.02 + ball.y * 0.01) * 0.2;
            const radius = 15 * scale; // Radiusni GRID_SIZE ga mosladim

            canvasCtx.beginPath();
            const gradient = canvasCtx.createRadialGradient(
                ball.x, ball.y, radius * 0.1, 
                ball.x, ball.y, radius
            );
            gradient.addColorStop(0, '#FFFFFF');
            gradient.addColorStop(0.5, ball.color);
            gradient.addColorStop(1, 'rgba(0,0,0,0)');

            canvasCtx.fillStyle = gradient;
            canvasCtx.arc(ball.x, ball.y, radius, 0, Math.PI * 2);
            canvasCtx.fill();
        });
    }

    // Oyna o'zgarsa tozalash
    window.addEventListener('resize', () => {
        canvasElement.width = window.innerWidth;
        canvasElement.height = window.innerHeight;
        balls = [];
        gridMap = {};
    });

</script>

</body>
</html>
