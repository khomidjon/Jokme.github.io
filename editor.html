<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate AI Studio</title>
    <style>
        /* --- KIBER DIZAYN (CSS) --- */
        body { 
            margin: 0; padding: 0; 
            background-color: #050505; 
            color: #e0e0e0; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
        }
        
        /* TEPADAGI PANEL */
        #top-bar { 
            height: 60px; background: #111; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 20px; border-bottom: 1px solid #333; 
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.1);
        }
        h1 { font-size: 18px; color: #00ffcc; letter-spacing: 2px; text-transform: uppercase; margin: 0; }
        
        /* KANVAS EKRANI (Markaziy) */
        #canvas-container { 
            flex: 1; 
            background: #000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: hidden; 
            position: relative;
            background-image: radial-gradient(circle, #111 1px, transparent 1px);
            background-size: 20px 20px; /* Panjara effekti */
        }
        
        canvas { 
            box-shadow: 0 0 40px rgba(0, 255, 204, 0.15); 
            cursor: crosshair; 
            max-width: 95%; 
            max-height: 95%; 
            object-fit: contain; /* Rasm ekranga sig'ishi uchun */
        }
        
        /* PASTKI PANEL (Qurollar) */
        #bottom-bar { 
            height: 130px; background: #111; 
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            gap: 10px; border-top: 1px solid #333; 
            padding: 10px;
        }

        .tools-row { display: flex; gap: 10px; align-items: center; width: 100%; justify-content: center; }
        
        /* TUGMALAR */
        .btn { 
            background: #222; color: #fff; border: 1px solid #444; 
            padding: 10px 15px; border-radius: 8px; cursor: pointer; 
            font-size: 14px; transition: all 0.2s; 
        }
        .btn:hover { border-color: #00ffcc; color: #00ffcc; }
        .btn.active { background: #00ffcc; color: #000; font-weight: bold; border-color: #00ffcc; box-shadow: 0 0 15px rgba(0, 255, 204, 0.4); }
        
        .btn-magic { 
            background: linear-gradient(90deg, #007bff, #00ffcc); 
            color: #000; font-weight: bold; border: none; padding: 12px 25px; 
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.3);
        }
        .btn-magic:active { transform: scale(0.95); }

        /* INPUTLAR */
        #prompt-input { 
            padding: 10px; border-radius: 8px; border: 1px solid #444; 
            background: #000; color: #00ffcc; width: 250px; outline: none; 
        }
        #strength-slider { width: 120px; accent-color: #00ffcc; cursor: pointer; }
        label { font-size: 11px; color: #888; text-transform: uppercase; font-weight: bold; }
        
        #file-input { display: none; }

        /* LOADING ANIMATSIYASI */
        #loading-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); display: none; 
            flex-direction: column; justify-content: center; align-items: center; 
            z-index: 999; backdrop-filter: blur(5px);
        }
        .scanner {
            width: 100%; height: 2px; background: #00ffcc;
            position: absolute; top: 0;
            animation: scan 2s infinite ease-in-out;
            box-shadow: 0 0 20px #00ffcc;
        }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        
        .loader-text { margin-top: 20px; color: #00ffcc; font-family: monospace; letter-spacing: 2px; }
    </style>
</head>
<body>

    <div id="top-bar">
        <h1>JOKKER AI STUDIO</h1>
        <button class="btn" onclick="document.getElementById('file-input').click()">üìÅ Rasm Yuklash</button>
        <input type="file" id="file-input" accept="image/*">
    </div>

    <div id="canvas-container">
        <div id="loading-overlay">
            <div class="scanner"></div>
            <p class="loader-text" id="loading-text">AI ISHLAMOQDA...</p>
        </div>
        <canvas id="main-canvas"></canvas>
    </div>

    <div id="bottom-bar">
        <div class="tools-row">
            <input type="text" id="prompt-input" placeholder="Promt aniq nima qilish">
            <div style="display: flex; flex-direction: column; align-items: center; gap: 3px;">
                <label>KUCH: <span id="strength-val">35%</span></label>
                <input type="range" id="strength-slider" min="0.1" max="1.0" step="0.05" value="0.35" oninput="document.getElementById('strength-val').innerText = Math.round(this.value*100) + '%'">
            </div>
        </div>

        <div class="tools-row">
            <button class="btn" onclick="undo()">‚Ü©Ô∏è Undo</button>
            <div style="width: 1px; height: 20px; background: #333;"></div>
            <button class="btn active" id="btn-brush" onclick="setTool('brush')">‚úèÔ∏è Qalam</button>
            <button class="btn" id="btn-eraser" onclick="setTool('eraser')">üßΩ O'chir</button>
            <button class="btn" onclick="clearCanvas()">üóë Toza</button>
            <div style="width: 1px; height: 20px; background: #333;"></div>
            <button class="btn btn-magic" onclick="generateAI()">‚ú® GENERATE</button>
            <button class="btn" onclick="downloadImage()">‚¨áÔ∏è</button>
        </div>
    </div>

    <script>
        // --- SOZLAMALAR ---
        const apiKey = "sk-SbO89p7YA2x5aL1EYYmZucaFSJeWuEiy7zutqiCKCIhXC9jA"; // Sizning kalitingiz
        
        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d');
        const fileInput = document.getElementById('file-input');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        let isDrawing = false, currentTool = 'brush';
        let originalImage = new Image();
        let originalWidth = 1024, originalHeight = 1024;
        let undoStack = [], undoStep = -1;

        // --- TARIX (UNDO) TIZIMI ---
        function saveState() {
            undoStep++;
            if (undoStep < undoStack.length) undoStack.length = undoStep;
            undoStack.push(canvas.toDataURL());
        }

        function undo() {
            if (undoStep > 0) {
                undoStep--;
                let img = new Image();
                img.src = undoStack[undoStep];
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.shadowBlur = 0;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                }
            }
        }

        // --- KANVAS BOSHLANG'ICH HOLATI ---
        function initCanvas() {
            // Ekranga moslab boshlang'ich o'lcham beramiz
            canvas.width = 800; canvas.height = 600;
            originalWidth = 800; originalHeight = 600;
            
            ctx.fillStyle = "#111"; // To'q fon
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.font = "30px Arial";
            ctx.fillStyle = "#333";
            ctx.textAlign = "center";
            ctx.fillText("RASM YUKLANG", canvas.width/2, canvas.height/2);
            
            saveState();
        }
        initCanvas();

        // --- RASM YUKLASH ---
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                originalImage.src = ev.target.result;
                originalImage.onload = () => {
                    // Kanvasni rasmga tenglashtiramiz
                    canvas.width = originalImage.width;
                    canvas.height = originalImage.height;
                    originalWidth = originalImage.width;
                    originalHeight = originalImage.height;
                    
                    ctx.shadowBlur = 0;
                    ctx.drawImage(originalImage, 0, 0);
                    saveState();
                }
            }
            reader.readAsDataURL(file);
        });

        // --- CHIZISH FUNKSIYALARI ---
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            // Rasm ekranda kichraytirilgan bo'lsa, masshtabni hisobga olish
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            let clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function startDraw(e) { isDrawing = true; draw(e); }
        function endDraw() { if(isDrawing) { isDrawing = false; ctx.beginPath(); saveState(); } }
        
        function draw(e) {
            if (!isDrawing) return;
            // Touch hodisalarida ekranni qimirlashini to'xtatish
            if(e.type === 'touchmove') e.preventDefault(); 

            const pos = getPos(e);

            // Qalam qalinligi rasm kattaligiga qarab o'zgaradi
            ctx.lineWidth = currentTool === 'brush' ? (canvas.width * 0.005) : (canvas.width * 0.04);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            if (currentTool === 'brush') {
                ctx.strokeStyle = '#FFFFFF'; // AI uchun OQ
                ctx.shadowBlur = canvas.width * 0.02; // Neon effekti
                ctx.shadowColor = '#00ffcc';
            } else {
                ctx.strokeStyle = '#000000'; // O'chirgich
                ctx.shadowBlur = 0;
            }

            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        // Hodisalar
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        window.addEventListener('mouseup', endDraw); // Ekranda tashqariga chiqsa ham to'xtasin
        
        canvas.addEventListener('touchstart', startDraw, {passive: false});
        canvas.addEventListener('touchmove', draw, {passive: false});
        window.addEventListener('touchend', endDraw);

        // --- TUGMALAR ---
        function setTool(tool) {
            currentTool = tool;
            document.getElementById('btn-brush').classList.toggle('active', tool === 'brush');
            document.getElementById('btn-eraser').classList.toggle('active', tool === 'eraser');
        }
        function clearCanvas() {
            ctx.shadowBlur = 0;
            ctx.drawImage(originalImage, 0, 0); // Asl rasmni qaytarish
            saveState();
        }
        function downloadImage() { 
            const link = document.createElement('a');
            link.download = 'jokker_art.png';
            link.href = canvas.toDataURL();
            link.click(); 
        }

        // --- TARJIMA FUNKSIYASI ---
        async function translateText(text) {
            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=uz|en`);
                const data = await res.json();
                return data.responseData.translatedText || text;
            } catch (e) {
                console.error(e);
                return text; // Xato bo'lsa o'zini qaytaradi
            }
        }

        // --- AI GENERATSIYA (YURAK) ---
        async function generateAI() {
            let promptUz = document.getElementById('prompt-input').value;
            if (!promptUz) { alert("Iltimos, nima chizishni yozing!"); return; }
            
            let strength = parseFloat(document.getElementById('strength-slider').value);

            loadingOverlay.style.display = 'flex';
            loadingText.innerText = "TARJIMA QILINMOQDA...";

            // 1. Tarjima
            let promptEn = await translateText(promptUz);
            loadingText.innerText = `AI: "${promptEn}"...`;

            // 2. Formatni to'g'irlash (Stability AI standartlari)
            const ratio = originalWidth / originalHeight;
            let targetW = 1024, targetH = 1024;
            
            if (ratio > 1.5) { targetW = 1344; targetH = 768; }
            else if (ratio > 1.1) { targetW = 1152; targetH = 896; }
            else if (ratio < 0.8) { targetW = 896; targetH = 1152; }
            else if (ratio < 0.6) { targetW = 768; targetH = 1344; }

            // 3. Vaqtincha kanvas yaratish (AI ga yuborish uchun)
            const tCanvas = document.createElement('canvas');
            tCanvas.width = targetW; tCanvas.height = targetH;
            const tCtx = tCanvas.getContext('2d');

            // Asl rasmni neon-siz ko'chiramiz
            ctx.shadowBlur = 0; 
            tCtx.drawImage(canvas, 0, 0, targetW, targetH);
            if(currentTool === 'brush') ctx.shadowBlur = canvas.width * 0.02; // Qaytarib yoqish

            tCanvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('init_image', blob);
                formData.append('init_image_mode', 'IMAGE_STRENGTH');
                formData.append('image_strength', strength);
                formData.append('text_prompts[0][text]', `${promptEn}, realistic, 8k resolution, highly detailed texture, cinematic lighting, photorealistic`);
                formData.append('text_prompts[1][text]', 'blur, cartoon, drawing, sketch, bad quality, text, watermark, ugly, deformed');
                formData.append('text_prompts[1][weight]', '-1');
                formData.append('cfg_scale', 9);
                formData.append('samples', 1);
                formData.append('steps', 35);

                try {
                    const response = await fetch('https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/image-to-image', {
                        method: 'POST',
                        headers: { 'Accept': 'application/json', 'Authorization': 'Bearer ' + apiKey },
                        body: formData,
                    });

                    if (!response.ok) throw new Error(await response.text());
                    const data = await response.json();

                    // Natijani ko'rsatish
                    const resultImg = new Image();
                    resultImg.src = `data:image/png;base64,${data.artifacts[0].base64}`;
                    resultImg.onload = () => {
                        ctx.shadowBlur = 0;
                        ctx.drawImage(resultImg, 0, 0, originalWidth, originalHeight); // Asl o'lchamga qaytarish
                        saveState();
                        loadingOverlay.style.display = 'none';
                    };

                } catch (err) {
                    loadingOverlay.style.display = 'none';
                    alert("XATOLIK: " + err.message);
                }
            }, 'image/png');
        }
    </script>
</body>
</html>
