<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JOKKER: Face Keeper Studio</title>
    <style>
        body { margin: 0; padding: 0; background-color: #050505; color: #fff; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        #top-bar { height: 60px; background: #111; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; border-bottom: 1px solid #333; }
        h1 { font-size: 18px; color: #00ffcc; letter-spacing: 1px; margin: 0; }
        
        /* KANVASLAR USTMA-UST */
        #canvas-container { flex: 1; display: flex; justify-content: center; align-items: center; background: #000; position: relative; overflow: hidden; }
        .canvas-layer { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 95%; max-height: 95%; }
        #image-layer { z-index: 1; } /* Asl rasm pastda */
        #draw-layer { z-index: 2; cursor: crosshair; opacity: 0.6; } /* Chizish tepada (shaffof) */

        #bottom-bar { height: 130px; background: #111; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 10px; border-top: 1px solid #333; padding: 10px; }
        .row { display: flex; gap: 10px; align-items: center; width: 100%; justify-content: center; }
        
        .btn { background: #222; color: #fff; border: 1px solid #444; padding: 10px 15px; border-radius: 8px; cursor: pointer; }
        .btn:hover { border-color: #00ffcc; color: #00ffcc; }
        .btn.active { background: #00ffcc; color: #000; font-weight: bold; }
        
        .btn-gen { 
            background: linear-gradient(90deg, #00ffcc, #007bff); color: #000; font-weight: bold; border: none; padding: 12px 30px; 
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.4);
        }

        #prompt-input { padding: 10px; border-radius: 8px; border: 1px solid #444; background: #000; color: #00ffcc; width: 250px; outline: none; }
        
        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 999; }
        .scanner { width: 100%; height: 2px; background: #00ffcc; position: absolute; animation: scan 2s infinite ease-in-out; box-shadow: 0 0 20px #00ffcc; }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        
        /* RANG TANLASH */
        .color-dot { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid #444; }
        .color-dot.active { border-color: #fff; transform: scale(1.2); }
    </style>
</head>
<body>

    <div id="top-bar">
        <h1>JOKKER INPAINTING</h1>
        <button class="btn" onclick="document.getElementById('file-input').click()">üìÅ Rasm Yuklash</button>
        <input type="file" id="file-input" accept="image/*" style="display:none">
    </div>

    <div id="canvas-container">
        <div id="loading-overlay">
            <div class="scanner"></div>
            <p style="margin-top:20px; color:#00ffcc;">YUZ SAQLANMOQDA... SOQOL EKILMOQDA...</p>
        </div>
        <canvas id="image-layer" class="canvas-layer"></canvas>
        <canvas id="draw-layer" class="canvas-layer"></canvas>
    </div>

    <div id="bottom-bar">
        <div class="row">
            <input type="text" id="prompt-input" placeholder="Nima chizish kerak? (Masalan: Qora soqol)">
        </div>

        <div class="row">
            <button class="btn" onclick="undo()">‚Ü©Ô∏è Undo</button>
            <button class="btn active" id="btn-brush" onclick="setTool('brush')">üñå Maska (Bo'yash)</button>
            <button class="btn" id="btn-eraser" onclick="setTool('eraser')">üßΩ O'chir</button>
            <button class="btn" onclick="clearMask()">üóë Toza</button>
            <button class="btn-gen" onclick="generateInpainting()">‚ú® GENERATE</button>
            <button class="btn" onclick="downloadImage()">‚¨áÔ∏è</button>
        </div>
    </div>

    <script>
        const apiKey = "sk-SbO89p7YA2x5aL1EYYmZucaFSJeWuEiy7zutqiCKCIhXC9jA"; 
        
        const imgCanvas = document.getElementById('image-layer');
        const imgCtx = imgCanvas.getContext('2d');
        const drawCanvas = document.getElementById('draw-layer');
        const drawCtx = drawCanvas.getContext('2d');
        const fileInput = document.getElementById('file-input');

        let isDrawing = false, currentTool = 'brush';
        let originalImage = new Image();
        let originalWidth = 1024, originalHeight = 1024;
        let undoStack = [], undoStep = -1;

        // --- TARIX ---
        function saveState() {
            undoStep++;
            if (undoStep < undoStack.length) undoStack.length = undoStep;
            undoStack.push(drawCanvas.toDataURL());
        }
        function undo() {
            if (undoStep > 0) {
                undoStep--;
                let img = new Image();
                img.src = undoStack[undoStep];
                img.onload = () => { drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height); drawCtx.drawImage(img,0,0); }
            } else { clearMask(false); }
        }

        // --- RASM YUKLASH ---
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                originalImage.src = ev.target.result;
                originalImage.onload = () => {
                    // O'lchamlarni moslash
                    imgCanvas.width = originalImage.width;
                    imgCanvas.height = originalImage.height;
                    drawCanvas.width = originalImage.width;
                    drawCanvas.height = originalImage.height;
                    
                    originalWidth = originalImage.width;
                    originalHeight = originalImage.height;

                    imgCtx.drawImage(originalImage, 0, 0);
                    clearMask(); // Yangi rasm kelganda maskani tozalash
                }
            }
            reader.readAsDataURL(file);
        });

        // --- MASKA CHIZISH ---
        function getPos(e) {
            const rect = drawCanvas.getBoundingClientRect();
            const scaleX = drawCanvas.width / rect.width;
            const scaleY = drawCanvas.height / rect.height;
            let x = (e.touches?e.touches[0].clientX:e.clientX) - rect.left;
            let y = (e.touches?e.touches[0].clientY:e.clientY) - rect.top;
            return { x: x*scaleX, y: y*scaleY };
        }

        function startDraw(e) { isDrawing = true; draw(e); }
        function endDraw() { if(isDrawing) { isDrawing=false; drawCtx.beginPath(); saveState(); } }
        
        function draw(e) {
            if(!isDrawing) return;
            if(e.type==='touchmove') e.preventDefault();
            const pos = getPos(e);
            
            drawCtx.lineCap = 'round';
            drawCtx.lineJoin = 'round';
            drawCtx.lineWidth = drawCanvas.width * 0.05; // Qalin cho'tka

            if (currentTool === 'brush') {
                drawCtx.globalCompositeOperation = 'source-over';
                drawCtx.strokeStyle = 'rgba(255, 255, 255, 1)'; // OQ MASKA (Ko'rinishi uchun shaffof oq)
                // Lekin AI ga qora-oq maska ketadi, shuning uchun bu yerda oq chizamiz
            } else {
                drawCtx.globalCompositeOperation = 'destination-out'; // O'chirish
            }
            
            drawCtx.lineTo(pos.x, pos.y);
            drawCtx.stroke();
            drawCtx.beginPath();
            drawCtx.moveTo(pos.x, pos.y);
        }

        drawCanvas.addEventListener('mousedown', startDraw); drawCanvas.addEventListener('mousemove', draw); window.addEventListener('mouseup', endDraw);
        drawCanvas.addEventListener('touchstart', startDraw, {passive:false}); drawCanvas.addEventListener('touchmove', draw, {passive:false}); window.addEventListener('touchend', endDraw);

        function setTool(t) { currentTool=t; document.getElementById('btn-brush').classList.toggle('active',t==='brush'); document.getElementById('btn-eraser').classList.toggle('active',t==='eraser'); }
        function clearMask(save=true) { drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height); if(save) saveState(); }
        
        function downloadImage() { 
            // Yuklashda ikkalasini birlashtiramiz
            const temp = document.createElement('canvas');
            temp.width = originalWidth; temp.height = originalHeight;
            const tCtx = temp.getContext('2d');
            tCtx.drawImage(imgCanvas,0,0);
            const link = document.createElement('a');
            link.download = 'jokker_face.png';
            link.href = imgCanvas.toDataURL(); // Hozircha faqat rasm qatlami
            link.click(); 
        }

        // --- TARJIMA ---
        async function translateText(text) {
            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=uz|en`);
                const data = await res.json();
                return data.responseData.translatedText || text;
            } catch(e) { return text; }
        }

        // --- INPAINTING GENERATSIYA ---
        async function generateInpainting() {
            let promptUz = document.getElementById('prompt-input').value;
            if(!promptUz) { alert("Prompt yozing!"); return; }
            
            document.getElementById('loading-overlay').style.display = 'flex';
            
            let promptEn = await translateText(promptUz);
            
            // 1. Rasmni tayyorlash
            const ratio = originalWidth/originalHeight;
            let tw=1024, th=1024;
            if(ratio>1.5) { tw=1344; th=768; } else if(ratio<0.7) { tw=768; th=1344; }

            const finalImgCanvas = document.createElement('canvas');
            finalImgCanvas.width=tw; finalImgCanvas.height=th;
            finalImgCanvas.getContext('2d').drawImage(imgCanvas,0,0,tw,th);

            // 2. MASKANI TAYYORLASH (AI uchun qora-oq)
            const maskCanvas = document.createElement('canvas');
            maskCanvas.width=tw; maskCanvas.height=th;
            const mCtx = maskCanvas.getContext('2d');
            mCtx.fillStyle = "black"; // Fon qora (o'zgarmaydigan joy)
            mCtx.fillRect(0,0,tw,th);
            mCtx.drawImage(drawCanvas,0,0,tw,th); // Biz chizgan joy (oq bo'lib tushadi)
            // AI da: OQ = O'zgaradi, QORA = O'zgarmaydi.
            
            // Convert to blobs
            const imgBlob = await new Promise(r => finalImgCanvas.toBlob(r, 'image/png'));
            const maskBlob = await new Promise(r => maskCanvas.toBlob(r, 'image/png'));

            const fd = new FormData();
            fd.append('init_image', imgBlob);
            fd.append('mask_image', maskBlob);
            fd.append('mask_source', 'MASK_IMAGE_WHITE'); // Oq joy maska deb belgilash
            fd.append('text_prompts[0][text]', `${promptEn}, realistic, 8k, photorealistic texture, blending naturally with skin`);
            fd.append('cfg_scale', 7);
            fd.append('samples', 1);
            fd.append('steps', 30);

            try {
                // ENDPOINT: MASKING
                const res = await fetch('https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/image-to-image/masking', {
                    method: 'POST', headers: {'Authorization': 'Bearer '+apiKey, 'Accept':'application/json'}, body: fd
                });
                if(!res.ok) throw new Error(await res.text());
                const data = await res.json();
                
                const resultImg = new Image();
                resultImg.src = `data:image/png;base64,${data.artifacts[0].base64}`;
                resultImg.onload = () => {
                    imgCtx.drawImage(resultImg,0,0,originalWidth,originalHeight); // Natijani joylash
                    clearMask(); // Maskani olib tashlash
                    document.getElementById('loading-overlay').style.display = 'none';
                }
            } catch(e) {
                document.getElementById('loading-overlay').style.display = 'none';
                alert("Xatolik: "+e.message);
            }
        }
    </script>
</body>
</html>
