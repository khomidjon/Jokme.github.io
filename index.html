<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis System - Auth</title>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #000; overflow: hidden; color: white;
        }

        /* Orqa fon animatsiyasi */
        .bg-animation {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite; opacity: 0.6;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Sarlavha qismi */
        .hero { text-align: center; margin-bottom: 30px; z-index: 10; }
        .hero h1 {
            font-size: 32px; font-weight: 700; margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .hero p { color: rgba(255, 255, 255, 0.7); font-size: 16px; }

        /* Login Oynasi (Glassmorphism) */
        .login-box {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px; padding: 40px; width: 100%; max-width: 400px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
            transition: 0.3s ease; z-index: 10; display: flex; flex-direction: column; gap: 15px;
        }
        .login-box:hover { border: 1px solid rgba(102, 126, 234, 0.4); }

        /* Inputlar va Tugmalar */
        input {
            width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3);
            color: white; font-size: 16px; outline: none; transition: 0.3s;
        }
        input:focus { border-color: #667eea; background: rgba(0,0,0,0.5); }
        
        button {
            width: 100%; padding: 14px; border-radius: 12px; border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; cursor: pointer; font-weight: bold; font-size: 16px;
            transition: 0.3s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4); }

        /* Google tugmasi joylashuvi */
        #buttonDiv { display: flex; justify-content: center; margin-top: 10px; }
        
        .divider {
            text-align: center; margin: 15px 0; color: rgba(255,255,255,0.4); font-size: 14px;
        }
    </style>
</head>
<body>

    <div class="bg-animation"></div>

    <div class="hero">
        <h1>XUSH KELIBSIZ!</h1>
        <p>JARVIS AI tizimiga kiring</p>
    </div>

    <div class="login-box">
        
        <div id="step-1">
            <input type="text" id="username" placeholder="Foydalanuvchi nomi (Username)">
            <input type="email" id="user-email" placeholder="Emailingiz">
            <input type="password" id="user-password" placeholder="Parol (8+ belgi, 1 ta katta harf)">
            <button onclick="startRegistration()">Davom etish</button>
        </div>

        <div id="step-2" style="display: none;">
            <p style="text-align: center; margin-bottom: 15px;">Emailingizga yuborilgan 5 talik kodni kiriting:</p>
            <input type="text" id="otp-input" maxlength="5" placeholder="12345" style="text-align: center; letter-spacing: 5px; font-size: 20px;">
            <button onclick="confirmAndSave()">Tasdiqlash</button>
        </div>

        <div class="divider">yoki Google orqali</div>

        <div id="buttonDiv"></div>
    </div>

    <script>
const firebaseConfig = {
            apiKey: "AIzaSyAg_n9-MsYSI41l_BqHWHuXrkE7I0fRfmo",
            authDomain: "my-universe-a5416.firebaseapp.com",
            projectId: "my-universe-a5416",
            storageBucket: "my-universe-a5416.firebasestorage.app",
            messagingSenderId: "960863192078",
            appId: "1:960863192078:web:b47ef80668ccbeea9d285f",
            measurementId: "G-FT3XEBVPZ8"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        (function() { emailjs.init("Gtorrbu3ZydFWOVZO"); })();

        // 2. GLOBAL O'ZGARUVCHILAR
        let generatedOTP = "";
        let userData = {};
        // Standart rasm (agar foydalanuvchida rasm bo'lmasa)
        const defaultAvatar = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

        // Agar allaqachon kirgan bo'lsa, dashboardga otamiz
        if (localStorage.getItem('atom_user')) {
            window.location.href = 'dashboard.html';
        }

        // 3. TABLARNI ALMASHTIRISH (Login vs Register)
        function switchTab(tab) {
            document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
            
            // Tugmalar rangini o'zgartirish
            document.getElementById('tab-login').classList.toggle('active', tab === 'login');
            document.getElementById('tab-register').classList.toggle('active', tab === 'register');
        }

        // 4. TIZIMGA KIRISH (LOGIN)
        async function loginUser() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) { alert("Email va parolni kiriting!"); return; }

            try {
                const snapshot = await db.collection("users")
                    .where("email", "==", email)
                    .where("password", "==", password).get();

                if (!snapshot.empty) {
                    const userDoc = snapshot.docs[0].data();
                    // LocalStoragega rasm bilan saqlaymiz
                    localStorage.setItem('atom_user', JSON.stringify({
                        name: userDoc.username,
                        email: userDoc.email,
                        picture: userDoc.picture || defaultAvatar // Rasm bo'lmasa standart rasm
                    }));
                    window.location.href = 'dashboard.html';
                } else {
                    alert("Email yoki parol noto'g'ri! Avval ro'yxatdan o'ting.");
                }
            } catch (error) { console.error(error); alert("Xatolik: " + error.message); }
        }

        // 5. RO'YXATDAN O'TISH
        function startRegistration() {
            const username = document.getElementById('reg-username').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-password').value;

            // Parol va input tekshiruvi...
            const regex = /^(?=.*[A-Z]).{8,}$/;
            if (!regex.test(pass)) { alert("Parol kuchsiz!"); return; }

            generatedOTP = Math.floor(10000 + Math.random() * 90000).toString();

            userData = {
                username: username,
                email: email,
                password: pass,
                picture: defaultAvatar, // Bazaga ham rasm qo'shamiz
                regDate: new Date().toLocaleString()
            };

            const templateParams = { email: email, passcode: generatedOTP, to_name: username };

            const btn = document.querySelector('#reg-step-1 button');
            btn.innerText = "Yuborilmoqda..."; btn.disabled = true;

            emailjs.send('service_tp046db', 'template_vwedq2m', templateParams)
                .then(() => {
                    alert("Kod yuborildi!");
                    document.getElementById('reg-step-1').style.display = 'none';
                    document.getElementById('reg-step-2').style.display = 'block';
                }, (err) => {
                    alert("Xatolik: " + JSON.stringify(err));
                    btn.disabled = false; btn.innerText = "Ro'yxatdan o'tish";
                });
        }

        async function confirmAndSave() {
            if (document.getElementById('otp-input').value === generatedOTP) {
                await db.collection("users").add(userData);
                localStorage.setItem('atom_user', JSON.stringify(userData));
                window.location.href = 'dashboard.html';
            } else { alert("Kod xato!"); }
        }

        function resendCode() { /* ... eski kod bilan bir xil ... */ }

        // 6. GOOGLE LOGIN
        function handleCredentialResponse(response) {
            const payload = JSON.parse(window.atob(response.credential.split('.')[1]));
            localStorage.setItem('atom_user', JSON.stringify({
                name: payload.name,
                email: payload.email,
                picture: payload.picture // Google rasmi
            }));
            window.location.href = 'dashboard.html';
        }

        window.onload = function () {
            google.accounts.id.initialize({
                client_id: "532407535407-t122jsgms7oqvtei0p46sb3bql3bpptu.apps.googleusercontent.com",
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(document.getElementById("buttonDiv"), { theme: "filled_black", size: "large", shape: "pill", width: "320" });
        };
    </script>
</body>
</html>
