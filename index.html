<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis System - Auth</title>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #000; overflow: hidden; color: white;
        }

        /* Orqa fon animatsiyasi */
        .bg-animation {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite; opacity: 0.6;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Sarlavha qismi */
        .hero { text-align: center; margin-bottom: 30px; z-index: 10; }
        .hero h1 {
            font-size: 32px; font-weight: 700; margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .hero p { color: rgba(255, 255, 255, 0.7); font-size: 16px; }

        /* Login Oynasi (Glassmorphism) */
        .login-box {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px; padding: 40px; width: 100%; max-width: 400px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
            transition: 0.3s ease; z-index: 10; display: flex; flex-direction: column; gap: 15px;
        }
        .login-box:hover { border: 1px solid rgba(102, 126, 234, 0.4); }

        /* Inputlar va Tugmalar */
        input {
            width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3);
            color: white; font-size: 16px; outline: none; transition: 0.3s;
        }
        input:focus { border-color: #667eea; background: rgba(0,0,0,0.5); }
        
        button {
            width: 100%; padding: 14px; border-radius: 12px; border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; cursor: pointer; font-weight: bold; font-size: 16px;
            transition: 0.3s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4); }

        /* Google tugmasi joylashuvi */
        #buttonDiv { display: flex; justify-content: center; margin-top: 10px; }
        
        .divider {
            text-align: center; margin: 15px 0; color: rgba(255,255,255,0.4); font-size: 14px;
        }
    </style>
</head>
<body>

    <div class="bg-animation"></div>

    <div class="hero">
        <h1>XUSH KELIBSIZ!</h1>
        <p>JARVIS AI tizimiga kiring</p>
    </div>

    <div class="login-box">
        
        <div id="step-1">
            <input type="text" id="username" placeholder="Foydalanuvchi nomi (Username)">
            <input type="email" id="user-email" placeholder="Emailingiz">
            <input type="password" id="user-password" placeholder="Parol (8+ belgi, 1 ta katta harf)">
            <button onclick="startRegistration()">Davom etish</button>
        </div>

        <div id="step-2" style="display: none;">
            <p style="text-align: center; margin-bottom: 15px;">Emailingizga yuborilgan 5 talik kodni kiriting:</p>
            <input type="text" id="otp-input" maxlength="5" placeholder="12345" style="text-align: center; letter-spacing: 5px; font-size: 20px;">
            <button onclick="confirmAndSave()">Tasdiqlash</button>
        </div>

        <div class="divider">yoki Google orqali</div>

        <div id="buttonDiv"></div>
    </div>

    <script>
        // ---------------------------------------------------------
        // 1. SOZLAMALAR (CONFIG) QISMI - SHU YERNI TOLDIRISH KERAK!
        // ---------------------------------------------------------
        
        // A. FIREBASE CONFIG (O'zingning console.firebase.google.com dagi ma'lumotlaringni qo'y)
        const firebaseConfig = {
            aapiKey: "AIzaSyAg_n9-MsYSI41l_BqHWHuXrkE7I0fRfmo",
            authDomain: "my-universe-a5416.firebaseapp.com",
            projectId: "my-universe-a5416",
            storageBucket: "my-universe-a5416.firebasestorage.app",
            messagingSenderId: "960863192078",
          appId: "1:960863192078:web:b47ef80668ccbeea9d285f",
          measurementId: "G-FT3XEBVPZ8"
        };
        
        // Firebase-ni ishga tushirish
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // B. EMAILJS INIT (Sening Public Keying)
        (function() {
            emailjs.init("Gtorrbu3ZydFWOVZO"); 
        })();

        // ---------------------------------------------------------
        // 2. GLOBAL O'ZGARUVCHILAR
        // ---------------------------------------------------------
        let generatedOTP = "";
        let userData = {};

        // Avval kirgan bo'lsa, to'g'ridan-to'g'ri o'tkazib yuborish
        if (localStorage.getItem('atom_user')) {
            window.location.href = 'dashboard.html';
        }

        // ---------------------------------------------------------
        // 3. FUNKSIYALAR
        // ---------------------------------------------------------

        // Parolni tekshirish funksiyasi
        function validatePassword(password) {
            // Kamida 8 ta belgi va kamida 1 ta katta harf
            const regex = /^(?=.*[A-Z]).{8,}$/;
            return regex.test(password);
        }

        // A. Ro'yxatdan o'tishni boshlash (Emailga kod yuborish)
        function startRegistration() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('user-email').value;
            const pass = document.getElementById('user-password').value;

            // Bo'sh joylarni tekshirish
            if (!username || !email || !pass) {
                alert("Iltimos, barcha maydonlarni to'ldiring!");
                return;
            }

            // Parol validatsiyasi
            if (!validatePassword(pass)) {
                alert("Parol xato! Kamida 8 ta belgi va 1 ta katta harf bo'lishi shart.");
                return;
            }

            // 5 xonali kod yaratish
            generatedOTP = Math.floor(10000 + Math.random() * 90000).toString();

            // Vaqtincha ma'lumotlarni saqlash
            userData = {
                username: username,
                email: email,
                password: pass, // Eslatma: Real loyihada parol shifrlanishi kerak
                regDate: new Date().toLocaleString()
            };

            // EmailJS orqali yuborish
            const templateParams = {
                to_email: email,
                otp_code: generatedOTP // Shabloningda {{otp_code}} bo'lishi kerak
            };

            
            emailjs.send('service_tp046db', 'template_vwedq2m', templateParams)
                .then(function() {
                    alert("Tasdiqlash kodi emailingizga yuborildi!");
                    // 1-oynani yopib, 2-oynani ochamiz
                    document.getElementById('step-1').style.display = 'none';
                    document.getElementById('step-2').style.display = 'block';
                }, function(error) {
                    console.error("EmailJS Xatosi:", error);
                    alert("Email yuborishda xatolik bo'ldi. Internetni tekshiring yoki keyinroq urining.");
                });
        }

        // B. Kodni tekshirish va Bazaga saqlash
        async function confirmAndSave() {
            const userInput = document.getElementById('otp-input').value;

            if (userInput === generatedOTP) {
                try {
                    // Firebase Firestore-ga yozish
                    await db.collection("users").add(userData);
                    
                    // LocalStorage-ga saqlash (Sessiya uchun)
                    localStorage.setItem('atom_user', JSON.stringify({
                        name: userData.username,
                        email: userData.email
                    }));

                    alert("Muvaffaqiyatli ro'yxatdan o'tdingiz!");
                    window.location.href = 'dashboard.html';
                    
                } catch (e) {
                    console.error("Firebase Xatosi:", e);
                    alert("Ma'lumotlarni serverga saqlashda xatolik yuz berdi. API Keylarni tekshiring.");
                }
            } else {
                alert("Kod noto'g'ri! Qaytadan tekshirib kiring.");
            }
        }

        // C. Google orqali kirish (Callback)
        function handleCredentialResponse(response) {
            console.log("Google Login boshlandi...");
            try {
                // Tokenni dekodlash
                const base64Url = response.credential.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const payload = JSON.parse(window.atob(base64));

                console.log("Salom, " + payload.name);

                // Saqlash
                localStorage.setItem('atom_user', JSON.stringify({
                    name: payload.name,
                    email: payload.email,
                    picture: payload.picture
                }));

                // Yo'naltirish
                window.location.href = 'dashboard.html';
            } catch (e) {
                console.error("Google Login Xatosi:", e);
            }
        }

        // ---------------------------------------------------------
        // 4. SAHIFA YUKLANGANDA (INIT)
        // ---------------------------------------------------------
        window.onload = function () {
            try {
                google.accounts.id.initialize({
                    client_id: "532407535407-t122jsgms7oqvtei0p46sb3bql3bpptu.apps.googleusercontent.com",
                    callback: handleCredentialResponse,
                    auto_select: false // Avtomatik tanlashni o'chirib turgan ma'qul
                });

                google.accounts.id.renderButton(
                    document.getElementById("buttonDiv"),
                    { theme: "filled_black", size: "large", shape: "pill", width: "320" }
                );

                // One Tap (ixtiyoriy)
                // google.accounts.id.prompt();
            } catch (err) {
                console.error("Google SDK yuklanmadi yoki xato:", err);
            }
        };
    </script>
</body>
</html>
