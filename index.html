<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis - Auth</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* DIZAYN O'ZGARISHSI QOLDI (Sizniki bilan bir xil) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #000; color: white; overflow: hidden; }
        .container { position: relative; z-index: 10; max-width: 450px; width: 90%; padding: 20px; }
        .login-box { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 40px; text-align: center; }
        input { width: 100%; padding: 14px; margin-bottom: 15px; background: rgba(255,255,255,0.1); border: 1px solid #444; color: white; border-radius: 10px; }
        button { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; border-radius: 10px; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }
        .hidden { display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <div class="login-box">
            <h2 id="title">Xush kelibsiz</h2>
            <p id="subtitle" style="margin-bottom: 20px; color: #ccc;">Tizimga kiring yoki ro'yxatdan o'ting</p>

            <div id="auth-form">
                <input type="text" id="username" placeholder="Ismingiz (faqat ro'yxatdan o'tishda)" class="hidden">
                <input type="email" id="email" placeholder="Email">
                <input type="password" id="password" placeholder="Parol">
                
                <button id="main-btn" onclick="handleAuth()">Kirish</button>
                
                <p style="margin-top: 15px; font-size: 14px; cursor: pointer; color: #667eea;" onclick="toggleMode()">
                    <span id="toggle-text">Hali hisobingiz yo'qmi? Ro'yxatdan o'tish</span>
                </p>
            </div>

            <div id="waiting-screen" class="hidden">
                <div class="loader"></div>
                <h3>Emailingizni tekshiring!</h3>
                <p style="font-size: 14px; color: #ccc; margin-top: 10px;">
                    Biz <b><span id="sent-email"></span></b> manziliga tasdiqlash havolasini yubordik.
                </p>
                <p style="font-size: 13px; color: #00d2ff; margin-top: 15px;">
                    Silkani bosishingiz bilan ushbu sahifa avtomatik yangilanadi...
                </p>
            </div>

        </div>
    </div>

    <script>
        // ---------------------------------------------------------
        // FIREBASE SOZLAMALARI
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyAg_n9-MsYSI41l_BqHWHuXrkE7I0fRfmo", 
            authDomain: "my-universe-a5416.firebaseapp.com",
            projectId: "my-universe-a5416",
            storageBucket: "my-universe-a5416.appspot.com",
            messagingSenderId: "960863192078",
            appId: "1:960863192078:web:b47ef80668ccbeea9d285f"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let isLogin = true;

        // ---------------------------------------------------------
        // AVTO-LOGIN (Agar email tasdiqlangan bo'lsa)
        // ---------------------------------------------------------
        auth.onAuthStateChanged((user) => {
            if (user && user.emailVerified) {
                // Foydalanuvchi tasdiqlangan -> Dashboardga o'tish
                saveUserAndRedirect(user);
            }
        });

        // ---------------------------------------------------------
        // KIRISH / RO'YXATDAN O'TISH MOSLAMASI
        // ---------------------------------------------------------
        function toggleMode() {
            isLogin = !isLogin;
            const title = document.getElementById('title');
            const btn = document.getElementById('main-btn');
            const toggleText = document.getElementById('toggle-text');
            const usernameInput = document.getElementById('username');

            if (isLogin) {
                title.innerText = "Xush kelibsiz";
                btn.innerText = "Kirish";
                toggleText.innerText = "Hali hisobingiz yo'qmi? Ro'yxatdan o'tish";
                usernameInput.classList.add('hidden');
            } else {
                title.innerText = "Ro'yxatdan o'tish";
                btn.innerText = "Ro'yxatdan o'tish";
                toggleText.innerText = "Hisobingiz bormi? Kirish";
                usernameInput.classList.remove('hidden');
            }
        }

        // ---------------------------------------------------------
        // ASOSIY FUNKSIYA
        // ---------------------------------------------------------
        function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value;
            const btn = document.getElementById('main-btn');

            if (!email || !password) {
                alert("Email va parolni kiriting!");
                return;
            }

            btn.innerText = "Bajarilmoqda...";
            btn.disabled = true;

            if (isLogin) {
                // --- KIRISH ---
                auth.signInWithEmailAndPassword(email, password)
                    .then((cred) => {
                        if (cred.user.emailVerified) {
                            saveUserAndRedirect(cred.user);
                        } else {
                            alert("Iltimos, avval emailingizga kelgan silkani tasdiqlang!");
                            btn.innerText = "Kirish";
                            btn.disabled = false;
                        }
                    })
                    .catch((err) => {
                        alert("Xato: " + err.message);
                        btn.innerText = "Kirish";
                        btn.disabled = false;
                    });
            } else {
                // --- RO'YXATDAN O'TISH ---
                if (!username) { alert("Ismingizni kiriting!"); return; }

                auth.createUserWithEmailAndPassword(email, password)
                    .then((cred) => {
                        // 1. Profilni yangilash
                        cred.user.updateProfile({ displayName: username });
                        
                        // 2. Bazaga yozish
                        db.collection("users").doc(cred.user.uid).set({
                            username: username,
                            email: email,
                            createdAt: new Date().toISOString()
                        });

                        // 3. Emailga silka yuborish
                        cred.user.sendEmailVerification().then(() => {
                            // 4. KUTISH EKRANINI YOQISH
                            document.getElementById('auth-form').classList.add('hidden');
                            document.getElementById('waiting-screen').classList.remove('hidden');
                            document.getElementById('sent-email').innerText = email;

                            // 5. AVTO-TEKSHIRUVNI BOSHLASH (Magic)
                            startEmailCheckTimer(cred.user);
                        });
                    })
                    .catch((err) => {
                        alert("Xato: " + err.message);
                        btn.innerText = "Ro'yxatdan o'tish";
                        btn.disabled = false;
                    });
            }
        }

        // ---------------------------------------------------------
        // SEHRLI KOD: Email tasdiqlanganini har 3 soniyada tekshiradi
        // ---------------------------------------------------------
        function startEmailCheckTimer(user) {
            const intervalId = setInterval(() => {
                // User ma'lumotlarini yangilash (Reload)
                user.reload().then(() => {
                    if (user.emailVerified) {
                        // AGAR TASDIQLANGAN BO'LSA -> TO'XTATISH VA O'TKAZISH
                        clearInterval(intervalId);
                        saveUserAndRedirect(user);
                    }
                });
            }, 3000); // Har 3 soniyada tekshiradi
        }

        function saveUserAndRedirect(user) {
            localStorage.setItem('atom_user', JSON.stringify({
                name: user.displayName || "Foydalanuvchi",
                email: user.email,
                uid: user.uid
            }));
            window.location.href = 'dashboard.html';
        }

    </script>
</body>
</html>
