<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>JARVIS - Neon Gravity</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Segoe UI', sans-serif; }
        video { display: none; } /* Kamerani yashiramiz, bizga faqat uning ma'lumoti kerak */
        
        #ui {
            position: absolute; top: 20px; left: 20px; color: white;
            z-index: 10; pointer-events: none;
        }
        h1 { margin: 0; font-size: 24px; text-shadow: 0 0 10px cyan; }
        p { font-size: 16px; color: #ccc; }
        #score-board { font-size: 40px; font-weight: bold; color: yellow; margin-top: 10px; }
        
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: cyan; font-size: 24px; font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="ui">
        <h1>NEON GRAVITY</h1>
        <p>✋ Ochiq qo'l = ITARISH (Qizil dushmanga qarshi)</p>
        <p>✊ Musht = TORTISH (Oltin yulduzni yutish)</p>
        <div id="score-board">0</div>
    </div>

    <div id="loading">AI MODEL YUKLANMOQDA...<br>(Kameraga ruxsat bering)</div>

    <video id="webcam" autoplay playsinline></video>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        // ------------------------------------------------------------------
        // 1. O'YIN SOZLAMALARI
        // ------------------------------------------------------------------
        let score = 0;
        let handX = 0, handY = 0; // Qo'l koordinatalari (0 dan 1 gacha)
        let isFist = false; // Musht qilinganmi?
        let particles = [];
        let targets = []; // Yig'iladigan narsalar
        let enemies = []; // Dushmanlar
        const PARTICLE_COUNT = 300; // Zarrachalar soni

        // ------------------------------------------------------------------
        // 2. THREE.JS (GRAFIKA)
        // ------------------------------------------------------------------
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 50;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Zarrachalar (Fon effekti uchun)
        const particleGeo = new THREE.BufferGeometry();
        const particlePos = new Float32Array(PARTICLE_COUNT * 3);
        const particleVel = []; // Tezlik vektorlari

        for(let i=0; i<PARTICLE_COUNT; i++) {
            particlePos[i*3] = (Math.random() - 0.5) * 100;
            particlePos[i*3+1] = (Math.random() - 0.5) * 60;
            particlePos[i*3+2] = 0;
            particleVel.push({x: 0, y: 0});
        }
        particleGeo.setAttribute('position', new THREE.BufferAttribute(particlePos, 3));
        const particleMat = new THREE.PointsMaterial({ color: 0x00ffff, size: 0.5 });
        const particleSystem = new THREE.Points(particleGeo, particleMat);
        scene.add(particleSystem);

        // Oltin Yulduz (Target)
        function spawnTarget() {
            const geo = new THREE.SphereGeometry(1.5, 16, 16);
            const mat = new THREE.MeshBasicMaterial({ color: 0xffd700 });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set((Math.random()-0.5)*80, (Math.random()-0.5)*50, 0);
            scene.add(mesh);
            targets.push({ mesh: mesh, active: true });
        }

        // Qizil Dushman (Enemy)
        function spawnEnemy() {
            const geo = new THREE.SphereGeometry(2, 16, 16); // Kattaroq
            const mat = new THREE.MeshBasicMaterial({ color: 0xff0000 }); // Qizil
            const mesh = new THREE.Mesh(geo, mat);
            // Dushmanlar chetidan chiqib keladi
            const side = Math.random() > 0.5 ? 1 : -1;
            mesh.position.set(side * 50, (Math.random()-0.5)*40, 0);
            
            // Dushman markazga qarab uchadi
            const velocity = {
                x: -side * (0.1 + Math.random() * 0.2),
                y: (Math.random() - 0.5) * 0.2
            };
            
            scene.add(mesh);
            enemies.push({ mesh: mesh, active: true, vel: velocity });
        }

        // Dastlabki obyektlar
        for(let i=0; i<5; i++) spawnTarget();
        setInterval(spawnEnemy, 2000); // Har 2 soniyada dushman

        // Qo'l ko'rsatkichi (Vizual)
        const handCursorGeo = new THREE.RingGeometry(2, 2.5, 32);
        const handCursorMat = new THREE.MeshBasicMaterial({ color: 0x00ff00, transparent: true, opacity: 0.8 });
        const handCursor = new THREE.Mesh(handCursorGeo, handCursorMat);
        scene.add(handCursor);

        // ------------------------------------------------------------------
        // 3. MEDIAPIPE (QO'L SKANERI)
        // ------------------------------------------------------------------
        const videoElement = document.getElementById('webcam');
        
        function onResults(results) {
            document.getElementById('loading').style.display = 'none';

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                
                // 1. Kaft markazini topish (9-nuqta - o'rta barmoq asosi)
                // Koordinatalarni Three.js olamiga o'giramiz
                // Video oyna (mirror) bo'lgani uchun X ni teskari qilamiz
                const x = (1 - landmarks[9].x) * 2 - 1; // -1 dan 1 gacha
                const y = -(landmarks[9].y * 2 - 1);    // -1 dan 1 gacha
                
                // Ekranga moslash (Masshtab)
                handX = x * 45; // Kenglik
                handY = y * 25; // Balandlik

                // 2. Mushtni aniqlash (Barmoq uchlari va asoslari orasidagi masofa)
                // Agar barmoq uchi (8) kaft (0) ga yaqin bo'lsa -> Musht
                const tipY = landmarks[8].y;
                const baseY = landmarks[5].y;
                
                // Oddiy mantiq: Agar ko'rsatkich barmog'i bukilgan bo'lsa
                if (landmarks[8].y > landmarks[6].y && landmarks[12].y > landmarks[10].y) {
                    isFist = true;
                    handCursor.material.color.setHex(0xff0000); // Qizil (Tortish kuchi)
                    handCursor.scale.set(0.5, 0.5, 1);
                } else {
                    isFist = false;
                    handCursor.material.color.setHex(0x00ff00); // Yashil (Itarish kuchi)
                    handCursor.scale.set(1.5, 1.5, 1); // Kattalashadi
                }

                handCursor.position.set(handX, handY, 0);
            }
        }

        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});
        
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        
        hands.onResults(onResults);

        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 640,
            height: 480
        });
        cameraUtils.start();

        // ------------------------------------------------------------------
        // 4. FIZIKA VA ANIMATSIYA (YURAK)
        // ------------------------------------------------------------------
        function animate() {
            requestAnimationFrame(animate);

            // A) Zarrachalar Fizikasi (Suv kabi oqim)
            const positions = particleSystem.geometry.attributes.position.array;
            
            for(let i=0; i<PARTICLE_COUNT; i++) {
                let px = positions[i*3];
                let py = positions[i*3+1];
                
                // Masofa
                let dx = handX - px;
                let dy = handY - py;
                let dist = Math.sqrt(dx*dx + dy*dy);
                
                // Kuch
                let force = 0;
                if (dist < 15) { // Tasir doirasi
                    if (isFist) {
                        force = 0.5; // Tortish (Musht)
                    } else {
                        force = -1.5; // Itarish (Ochiq qo'l) - Kuchliroq
                    }
                }

                // Tezlikni o'zgartirish
                particleVel[i].x += (dx / dist) * force * 0.1;
                particleVel[i].y += (dy / dist) * force * 0.1;
                
                // Ishqalanish (Sekinlashish)
                particleVel[i].x *= 0.95;
                particleVel[i].y *= 0.95;

                // Joylashuvni yangilash
                positions[i*3] += particleVel[i].x;
                positions[i*3+1] += particleVel[i].y;

                // Chegaradan chiqib ketsa qaytarish
                if (positions[i*3] > 60) positions[i*3] = -60;
                if (positions[i*3] < -60) positions[i*3] = 60;
                if (positions[i*3+1] > 40) positions[i*3+1] = -40;
                if (positions[i*3+1] < -40) positions[i*3+1] = 40;
            }
            particleSystem.geometry.attributes.position.needsUpdate = true;

            // B) O'YIN MANTIG'I (Game Logic)
            
            // 1. Oltin Yulduzlar (Target)
            targets.forEach((t, index) => {
                if (!t.active) return;
                
                let dist = t.mesh.position.distanceTo(new THREE.Vector3(handX, handY, 0));
                
                // Agar musht bo'lsa, yulduzlar qo'lga uchib keladi
                if (isFist && dist < 20) {
                    t.mesh.position.lerp(new THREE.Vector3(handX, handY, 0), 0.1);
                }

                // Agar yutsa
                if (dist < 3) {
                    score += 10;
                    document.getElementById('score-board').innerText = score;
                    scene.remove(t.mesh);
                    t.active = false;
                    spawnTarget(); // Yangisini chiqarish
                    
                    // Kichik "pop" effekti (Rang o'zgarishi)
                    handCursor.material.color.setHex(0xffff00);
                    setTimeout(() => handCursor.material.color.setHex(0xff0000), 100);
                }
                
                t.mesh.rotation.z += 0.02; // Aylanish
            });

            // 2. Qizil Dushmanlar (Enemies)
            enemies.forEach((e, index) => {
                if (!e.active) return;
                
                // Harakat
                e.mesh.position.x += e.vel.x;
                e.mesh.position.y += e.vel.y;

                // Qo'l bilan to'qnashuv
                let dist = e.mesh.position.distanceTo(new THREE.Vector3(handX, handY, 0));
                
                // Agar ochiq qo'l bo'lsa (Shield) -> Dushmanni itarib yuboradi
                if (!isFist && dist < 8) {
                    e.vel.x = (e.mesh.position.x - handX) * 0.2; // Orqaga otish
                    e.vel.y = (e.mesh.position.y - handY) * 0.2;
                    score += 5; // Himoya uchun ochko
                    document.getElementById('score-board').innerText = score;
                }
                // Agar musht bo'lsa va tegib ketsa -> Yutqazish
                else if (isFist && dist < 4) {
                    score -= 50; // Jarima
                    if(score < 0) score = 0;
                    document.getElementById('score-board').innerText = score;
                    scene.remove(e.mesh);
                    e.active = false;
                    document.body.style.backgroundColor = "red"; // Ekranni qizil qilish
                    setTimeout(() => document.body.style.backgroundColor = "#050505", 200);
                }

                // Chegaradan chiqib ketsa o'chirish
                if (Math.abs(e.mesh.position.x) > 60 || Math.abs(e.mesh.position.y) > 40) {
                    scene.remove(e.mesh);
                    e.active = false;
                }
            });

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
