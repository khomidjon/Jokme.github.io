<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS - Neon Gravity (Fixed)</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: sans-serif; }
        
        /* Debug uchun videoni kichkina qilib ko'rsatamiz */
        #webcam {
            position: absolute; bottom: 10px; right: 10px;
            width: 160px; height: 120px;
            border: 2px solid cyan; border-radius: 8px;
            transform: scaleX(-1); /* Ko'zgu effekti */
            z-index: 100; opacity: 0.7;
        }

        #ui {
            position: absolute; top: 20px; left: 20px; color: white;
            z-index: 10; pointer-events: none;
        }
        h1 { margin: 0; font-size: 28px; text-shadow: 0 0 10px cyan; }
        p { font-size: 16px; color: #ccc; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 4px; }
        #score-board { font-size: 50px; font-weight: bold; color: yellow; margin-top: 10px; }
        
        #status {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: cyan; font-size: 24px; font-weight: bold; text-align: center;
            background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;
            z-index: 20;
        }

        /* Xatoliklar ekrani */
        #error-log {
            position: absolute; top: 0; right: 0; width: 300px;
            color: red; background: rgba(0,0,0,0.8);
            font-size: 12px; padding: 10px; display: none; z-index: 999;
        }
    </style>
</head>
<body>

    <div id="error-log"></div>

    <div id="ui">
        <h1>NEON GRAVITY</h1>
        <p>✋ Ochiq qo'l = ITARISH (Qizilga qarshi)</p>
        <p>✊ Musht = TORTISH (Sariqni yutish)</p>
        <div id="score-board">0</div>
    </div>

    <div id="status">TIZIM YUKLANMOQDA...<br><span style="font-size:16px; color:white">Iltimos, kameraga ruxsat bering</span></div>

    <video id="webcam" playsinline></video>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        // XATOLARNI USHLASH
        window.onerror = function(message) {
            const el = document.getElementById('error-log');
            el.style.display = 'block';
            el.innerHTML += "XATO: " + message + "<br>";
        };

        // 1. THREE.JS (GRAFIKA)
        const scene = new THREE.Scene();
        // Fonni biroz ko'kimtir qilamiz, qora ekran bo'lib qolmasligi uchun
        scene.background = new THREE.Color(0x0a0a15); 
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 50;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // O'YIN ELEMENTLARI
        let score = 0;
        let handX = 0, handY = 0;
        let isFist = false;
        let isHandDetected = false;
        const targets = [];
        const enemies = [];
        
        // Zarrachalar (Fon)
        const particleCount = 400;
        const particleGeo = new THREE.BufferGeometry();
        const particlePos = new Float32Array(particleCount * 3);
        const particleVel = [];

        for(let i=0; i<particleCount; i++) {
            particlePos[i*3] = (Math.random() - 0.5) * 120;
            particlePos[i*3+1] = (Math.random() - 0.5) * 80;
            particlePos[i*3+2] = 0;
            particleVel.push({x: 0, y: 0});
        }
        particleGeo.setAttribute('position', new THREE.BufferAttribute(particlePos, 3));
        const particleMat = new THREE.PointsMaterial({ color: 0x00ffff, size: 0.8 });
        const particles = new THREE.Points(particleGeo, particleMat);
        scene.add(particles);

        // Qo'l Kursor
        const cursorGeo = new THREE.RingGeometry(2, 3, 32);
        const cursorMat = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        const cursor = new THREE.Mesh(cursorGeo, cursorMat);
        scene.add(cursor);

        // 2. FUNKSIYALAR
        function spawnTarget() {
            const geo = new THREE.SphereGeometry(2, 16, 16);
            const mat = new THREE.MeshBasicMaterial({ color: 0xffd700 });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set((Math.random()-0.5)*100, (Math.random()-0.5)*60, 0);
            scene.add(mesh);
            targets.push({ mesh: mesh, active: true });
        }

        function spawnEnemy() {
            const geo = new THREE.SphereGeometry(2.5, 16, 16);
            const mat = new THREE.MeshBasicMaterial({ color: 0xff0000 });
            const mesh = new THREE.Mesh(geo, mat);
            const side = Math.random() > 0.5 ? 1 : -1;
            mesh.position.set(side * 60, (Math.random()-0.5)*40, 0);
            const vel = { x: -side * (0.1 + Math.random()*0.2), y: (Math.random()-0.5)*0.2 };
            scene.add(mesh);
            enemies.push({ mesh: mesh, active: true, vel: vel });
        }

        // Boshlang'ich obyektlar
        for(let i=0; i<6; i++) spawnTarget();
        setInterval(spawnEnemy, 2500);

        // 3. MEDIAPIPE LOGIKASI
        const videoElement = document.getElementById('webcam');
        const statusElement = document.getElementById('status');

        function onResults(results) {
            // Agar qo'l topilsa
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                isHandDetected = true;
                statusElement.style.display = 'none'; // Yozuvni yo'qotish
                
                const landmarks = results.multiHandLandmarks[0];
                
                // Koordinata (9 - O'rta barmoq asosi)
                const x = (1 - landmarks[9].x) * 2 - 1; 
                const y = -(landmarks[9].y * 2 - 1);
                
                // Yumshatish (Smooth movement)
                handX += (x * 55 - handX) * 0.2;
                handY += (y * 35 - handY) * 0.2;

                // Mushtni aniqlash
                const tip = landmarks[8].y;  // Ko'rsatkich uchi
                const base = landmarks[5].y; // Ko'rsatkich asosi
                const pinkyTip = landmarks[20].y;
                const pinkyBase = landmarks[17].y;

                // Agar barmoqlar bukilgan bo'lsa
                if (tip > landmarks[6].y && pinkyTip > landmarks[18].y) {
                    isFist = true;
                    cursor.material.color.setHex(0xff0000); // Qizil
                    cursor.scale.set(0.7, 0.7, 1);
                } else {
                    isFist = false;
                    cursor.material.color.setHex(0x00ff00); // Yashil
                    cursor.scale.set(1.2, 1.2, 1);
                }

                cursor.position.set(handX, handY, 0);
            } else {
                isHandDetected = false;
                statusElement.style.display = 'block';
                statusElement.innerHTML = "QO'L KO'RINMAYAPTI<br><span style='font-size:16px; color:white'>Qo'lingizni kameraga ko'rsating</span>";
            }
        }

        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});
        
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        
        hands.onResults(onResults);

        // Kamerani ishga tushirish
        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 640,
            height: 480
        });
        
        cameraUtils.start()
            .then(() => { console.log("Kamera ishga tushdi"); })
            .catch(err => { 
                alert("Kameraga ulanib bo'lmadi! Iltimos ruxsat bering.");
                console.error(err); 
            });


        // 4. ANIMATSIYA
        function animate() {
            requestAnimationFrame(animate);

            // Zarrachalar harakati
            const positions = particles.geometry.attributes.position.array;
            for(let i=0; i<particleCount; i++) {
                let px = positions[i*3];
                let py = positions[i*3+1];
                
                // Qo'l ta'siri
                if (isHandDetected) {
                    let dx = handX - px;
                    let dy = handY - py;
                    let dist = Math.sqrt(dx*dx + dy*dy);

                    if (dist < 20) {
                        let force = isFist ? 0.8 : -1.2; // Tortish yoki Itarish
                        particleVel[i].x += (dx/dist) * force * 0.05;
                        particleVel[i].y += (dy/dist) * force * 0.05;
                    }
                }

                // Tabiiy harakat
                particleVel[i].x *= 0.95; 
                particleVel[i].y *= 0.95;
                positions[i*3] += particleVel[i].x;
                positions[i*3+1] += particleVel[i].y;

                // Chegaradan qaytish
                if(positions[i*3] > 60 || positions[i*3] < -60) positions[i*3] *= -0.9;
                if(positions[i*3+1] > 40 || positions[i*3+1] < -40) positions[i*3+1] *= -0.9;
            }
            particles.geometry.attributes.position.needsUpdate = true;

            // Obyektlar mantig'i
            targets.forEach(t => {
                if(!t.active) return;
                let d = t.mesh.position.distanceTo(new THREE.Vector3(handX, handY, 0));
                if(isFist && d < 25 && isHandDetected) t.mesh.position.lerp(new THREE.Vector3(handX, handY, 0), 0.05);
                if(d < 3 && isHandDetected && isFist) {
                    score += 10;
                    document.getElementById('score-board').innerText = score;
                    scene.remove(t.mesh); t.active = false;
                    spawnTarget();
                }
            });

            enemies.forEach(e => {
                if(!e.active) return;
                e.mesh.position.x += e.vel.x; e.mesh.position.y += e.vel.y;
                let d = e.mesh.position.distanceTo(new THREE.Vector3(handX, handY, 0));
                
                if(!isFist && d < 10 && isHandDetected) {
                    e.vel.x = (e.mesh.position.x - handX) * 0.3;
                    e.vel.y = (e.mesh.position.y - handY) * 0.3;
                } else if(isFist && d < 4 && isHandDetected) {
                    score -= 50; if(score < 0) score = 0;
                    document.getElementById('score-board').innerText = score;
                    scene.remove(e.mesh); e.active = false;
                    document.body.style.background = "red";
                    setTimeout(() => document.body.style.background = "#050505", 100);
                }
                
                if(Math.abs(e.mesh.position.x) > 70) { scene.remove(e.mesh); e.active = false; }
            });

            renderer.render(scene, camera);
        }

        animate();
        
        // Oynani o'lchamini to'g'irlash
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
